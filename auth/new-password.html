<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Set New Password</title>
    <style>
      body { font-family: system-ui, sans-serif; padding: 24px; max-width: 420px; margin: 0 auto; }
      input, button { width: 100%; padding: 12px; margin-top: 12px; }
      .hint { color:#666; font-size:14px; }
    </style>
  </head>
  <body>
    <h1>Set a new password</h1>
    <p class="hint">Choose a new password for your account.</p>

    <input id="pw1" type="password" placeholder="New password" autocomplete="new-password" />
    <input id="pw2" type="password" placeholder="Confirm new password" autocomplete="new-password" />
    <button id="saveBtn">Save password</button>
    <p id="msg" class="hint"></p>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../shared/api.js"></script>
    <script>
      const msg = document.getElementById('msg');
      const pw1 = document.getElementById('pw1');
      const pw2 = document.getElementById('pw2');

      document.getElementById('saveBtn').addEventListener('click', async () => {
        msg.textContent = '';

        if (!pw1.value || pw1.value !== pw2.value) {
          msg.textContent = 'Passwords must match.';
          return;
        }

        // must be signed in via confirmed.html -> exchangeCodeForSession
        const { data: { user }, error: uErr } = await supabase.auth.getUser();
        if (!user || uErr) {
          msg.textContent = 'Session not found. Please use the link in your email again or sign in.';
          return;
        }

        const { error } = await supabase.auth.updateUser({ password: pw1.value });
        if (error) {
          msg.textContent = 'Could not update password: ' + error.message;
        } else {
          msg.textContent = 'Password updated. Redirectingâ€¦';
          setTimeout(() => location.replace('./signin.html'), 1000);
        }
      });
    </script>
  </body>
</html>
