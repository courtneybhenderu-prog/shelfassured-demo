name: Security Review Automation

on:
  schedule:
    # Monthly reminder on the 1st at 9 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  security-reminder:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Last Reviewed date
      run: |
        # Update the last reviewed date in the security checklist
        sed -i "s/Last Reviewed:.*/Last Reviewed: $(date +'%Y-%m-%d')/" docs/security-review-checklist.md
        
        # Add a review log entry
        echo "" >> docs/security-review-checklist.md
        echo "## 📅 Review Log" >> docs/security-review-checklist.md
        echo "- **$(date +'%Y-%m-%d')**: Monthly security review reminder sent" >> docs/security-review-checklist.md
    
    - name: Create Security Review Issue
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `🔐 Monthly Security Review - ${new Date().toLocaleDateString()}`,
            body: `## 🔐 Monthly Security Review Reminder
            
            **Date:** ${new Date().toLocaleDateString()}
            **Estimated Time:** 30 minutes
            **Priority:** High
            
            ### 📋 Checklist
            Please complete the security review checklist:
            - [ ] Review [Security Checklist](docs/security-review-checklist.md)
            - [ ] Focus on Phase 1 items
            - [ ] Check for any new security concerns
            - [ ] Update documentation if needed
            
            ### 🎯 Critical Items to Check
            - [ ] API key security
            - [ ] Database RLS policies  
            - [ ] Authentication flows
            - [ ] User access controls
            
            ### 📞 Resources
            - [Quick Reference](docs/security-quick-reference.md)
            - [Full Checklist](docs/security-review-checklist.md)
            
            **Please complete this review within 7 days and close this issue when done.**`,
            labels: ['security', 'monthly-review', 'high-priority']
          });
          
          console.log(`Created issue #${issue.data.number}`);
    
    - name: Commit updated documentation
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "actions@github.com"
        git add docs/security-review-checklist.md
        git commit -m "chore: update security review date and log" || exit 0
        git push || exit 0
    
    - name: Send notification (optional)
      if: success()
      run: |
        echo "✅ Security review reminder sent successfully!"
        echo "📋 Checklist updated with new date"
        echo "🎫 GitHub issue created for tracking"
