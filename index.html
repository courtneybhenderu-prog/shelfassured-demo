<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ShelfAssured ‚Äî Prototype (Add Client + Your Brands)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
  :root{
    --sa-red:#C62828; --sa-red-hover:#9F1F1F;
    --sa-gray:#E5E7EB; --sa-gray-hover:#D1D5DB;
    --sa-gold:#F9A825; --sa-text:#374151;
  }
  html,body{height:100%;}
  body{ font-family:'Inter',sans-serif; background:#f3f4f6; color:#2d231e; }
  .shell{ max-width:420px; margin:0 auto; }
  .phone{ background:#fcfbf9; border:4px solid #3d342f; border-radius:1.5rem; overflow:hidden; min-height:820px; position:relative; }
  .screen{ padding:1.25rem; min-height:820px; }
  .taskbar{ position:sticky; bottom:0; background:#fff; padding:1rem; box-shadow:0 -4px 12px rgba(0,0,0,.08); border-top-left-radius:1rem; border-top-right-radius:1rem; }
  .section-title{ font-size:1.75rem; font-weight:800; color:#1f2937; }
  .sa-card{ background:#fff; border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.08); }
  .value{ background:var(--sa-gold); color:#111827; font-weight:600; border-radius:9999px; padding:.25rem .6rem; display:inline-block; }
  .btn-red{
    background:var(--sa-red); color:#fff; font-weight:700;
    border-radius:9999px; padding:.85rem 1.1rem;
    box-shadow:0 6px 14px rgba(0,0,0,.12); transition:.15s ease;
  }
  .btn-red:hover{ background:var(--sa-red-hover); }
  .btn-gray{
    background:var(--sa-gray); color:var(--sa-text); font-weight:700;
    border-radius:9999px; padding:.85rem 1.1rem;
    box-shadow:0 6px 14px rgba(0,0,0,.08); transition:.15s ease;
  }
  .btn-gray:hover{ background:var(--sa-gray-hover); }

  /* Quick Nav (dropdown) */
  #menuBtn{
    position:fixed; right:16px; top:16px; z-index:40;
    background:#111827; color:#fff; border-radius:.75rem; padding:.5rem .85rem; font-weight:700;
  }
  #quickNav{
    position:fixed; left:50%; transform:translateX(-50%);
    top:64px; z-index:50; width:92%; max-width:540px;
    background:#ffffff; border-radius:1rem; box-shadow:0 10px 28px rgba(0,0,0,.22);
    padding:1rem; display:none;
  }
  #quickNav.open{ display:block; }
  #navMask{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.2); z-index:40;
  }
  #navMask.open{ display:block; }

  /* Brand cards */
  .brand-card{ text-align:center; padding:1rem; }
  .brand-card .logo{
    width:5rem; height:5rem; border-radius:9999px; background:#F3F4F6;
    display:flex; align-items:center; justify-content:center; margin:0 auto;
    font-weight:700; color:#9CA3AF;
  }

  /* Loading spinner */
  .loading{ border:4px solid #f3f3f3; border-top:4px solid var(--sa-red); border-radius:50%; width:28px; height:28px; animation:spin 1s linear infinite; margin:0 auto; }
  @keyframes spin{ to{ transform:rotate(360deg);} }

  /* Print ‚Äî only snapshot */
  @media print{
    body *{ visibility:hidden; }
    #screen19, #screen19 *{ visibility:visible; }
    #screen19{ position:absolute; inset:0; }
  }
</style>
</head>
<body>
<button id="menuBtn">‚â° Menu</button>
<div id="navMask"></div>
<div id="quickNav" class="sa-card">
  <h3 class="font-extrabold text-gray-800 text-lg mb-2">Quick Nav (Admin)</h3>
  <div class="grid grid-cols-2 gap-3 text-center">
    <button data-goto="screen1" class="btn-gray">Splash</button>
    <button data-goto="screen4" class="btn-gray">Shopper Dashboard</button>
    <button data-goto="screen5" class="btn-gray">Job Details</button>
    <button data-goto="screen6" class="btn-gray">Photo Capture</button>
    <button data-goto="screen7" class="btn-gray">Analysis</button>
    <button data-goto="screen8" class="btn-gray">Client Dashboard</button>
    <button data-goto="screen13" class="btn-gray">Client: New Job</button>
    <button data-goto="screen19" class="btn-gray">Client Snapshot</button>
    <button data-goto="screen14" class="btn-gray">Admin Dashboard</button>
    <button data-goto="screen15" class="btn-gray">Admin: Users</button>
    <button data-goto="screen16" class="btn-gray">Admin: Jobs</button>
    <button data-goto="screen17" class="btn-gray">Admin: Support</button>
    <button data-goto="screen10" class="btn-gray">Brands</button>
    <button data-goto="screen11" class="btn-gray">Profile</button>
    <button data-goto="screen9"  class="btn-gray">My Jobs</button>
    <button data-goto="screen20" class="btn-gray">Create Job (Form)</button>
    <button data-goto="screen21" class="btn-gray">Add Client</button>
  </div>
</div>

<div class="shell">
  <div class="phone">

    <!-- screen1: Splash -->
    <section id="screen1" class="screen flex flex-col justify-center text-center">
      <div class="mb-3">
        <h1 class="text-4xl font-extrabold text-[#424242]">Shelf<span class="text-[#F9A825]">Assured</span></h1>
      </div>
      <p class="text-lg text-gray-600 max-w-xs mx-auto">Helping emerging brands see their products on shelves in real time.</p>
      <div class="mt-10 space-y-3 px-6">
        <button class="w-full btn-red" onclick="go('screen2')">Create Account</button>
        <button class="w-full btn-gray" onclick="go('screen3')">Sign In</button>
        <button class="w-full btn-gray" onclick="go('screen8')">Client Login</button>
        <button class="w-full btn-gray" onclick="go('screen14')">Admin Login</button>
      </div>
      <p class="text-xs text-gray-500 mt-6">By continuing, you agree to our <a class="underline">Terms</a>.</p>
    </section>

    <!-- screen2: Create Account -->
    <section id="screen2" class="screen">
      <h2 class="section-title">Create Account</h2>
      <p class="text-gray-500">Choose a method to get started.</p>
      <div class="mt-6 space-y-4">
        <button class="w-full btn-gray">Sign in with Google</button>
        <button class="w-full btn-red" onclick="go('screen11')">Continue with Email</button>
        <button class="w-full btn-gray" onclick="go('screen1')">Back</button>
      </div>
    </section>

    <!-- screen3: Sign In -->
    <section id="screen3" class="screen">
      <h2 class="section-title">Welcome Back!</h2>
      <p class="text-gray-500">Sign in to your account.</p>
      <div class="mt-4 space-y-3">
        <input id="login-email" type="email" placeholder="Email" class="w-full border rounded px-3 py-3"/>
        <input id="login-pass" type="password" placeholder="Password" class="w-full border rounded px-3 py-3"/>
        <button class="w-full btn-red" onclick="go('screen4')">Sign In</button>
        <button class="w-full btn-gray" onclick="go('screen2')">Sign up</button>
      </div>
    </section>

    <!-- screen4: Shopper Dashboard -->
    <section id="screen4" class="screen">
      <h2 class="section-title">Hello, Courtney!</h2>
      <p class="text-gray-500">Your ShelfAssured Dashboard</p>
      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="sa-card p-4"><p class="text-sm text-gray-500">Total Income</p><p id="total-income" class="text-2xl font-bold">$15.00</p></div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:var(--sa-red)"><p class="text-sm text-gray-500">Current Jobs</p><p class="text-2xl font-bold">4</p></div>
      </div>

      <div class="mt-5">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold">Jobs Near You</h3>
          <span class="sa-pill">Filter</span>
        </div>

        <div class="mt-3 space-y-2" id="jobs-static">
        <script>
          (function () {
            var container = document.getElementById('jobs-static');
            if (!container) return;
            container.innerHTML = '';
            var jobs = (window.saGet && saGet('jobs')) || [];
            var stores = (window.saGet && saGet('stores')) || [];

            jobs.forEach(function (job) {
              var nStores = job && job.allStores ? stores.length : ((job && job.storeIds) ? job.storeIds.length : 0);
              var skuCount = (job && job.skuIds) ? job.skuIds.length : 0;
              var perStore = (job && job.payoutPerStore) ? job.payoutPerStore : 5;
              var payout = perStore * nStores;
              var title = (job && (job.title || job.clientName || (job.client && job.client.name))) || 'Untitled Job';

              var card = document.createElement('div');
              card.className = 'sa-card p-4 flex items-center justify-between';

              var left = document.createElement('div');
              var titleEl = document.createElement('p');
              titleEl.className = 'font-bold';
              titleEl.textContent = title;
              var subEl = document.createElement('p');
              subEl.className = 'text-sm text-gray-500';
              subEl.textContent = (nStores || 0) + ' ' + (nStores === 1 ? 'store' : 'stores') + ' ‚Ä¢ ' + (skuCount || 0) + ' ' + (skuCount === 1 ? 'SKU' : 'SKUs');
              left.appendChild(titleEl);
              left.appendChild(subEl);

              var right = document.createElement('div');
              right.className = 'text-right flex items-end gap-3';
              var amounts = document.createElement('div');
              var payoutEl = document.createElement('div');
              payoutEl.className = 'text-xl font-semibold text-[#F9A825]';
              payoutEl.textContent = '$' + payout;
              var perEl = document.createElement('div');
              perEl.className = 'text-xs text-gray-500';
              perEl.textContent = '$' + perStore + '/store';
              amounts.appendChild(payoutEl);
              amounts.appendChild(perEl);

              var btn = document.createElement('button');
              btn.className = 'sa-btn px-3 py-1 text-sm';
              btn.textContent = 'Start';
              btn.addEventListener('click', function () {
                if (job && job.id != null) {
                  location.hash = '#job/' + job.id;
                }
              });

              right.appendChild(amounts);
              right.appendChild(btn);

              card.appendChild(left);
              card.appendChild(right);
              container.appendChild(card);
            });
          })();
        </script>
        </div>

        <!-- dynamic jobs published by admin/client -->
        <div id="jobs-dynamic" class="mt-3 space-y-2"></div>
      </div>

      <div class="taskbar mt-6">
        <div class="flex justify-around text-gray-500">
          <button class="font-bold text-[#C62828]">Dashboard</button>
          <button class="" onclick="go('screen9')">Jobs</button>
          <button class="" onclick="go('screen10')">Brands</button>
          <button class="" onclick="go('screen11')">Profile</button>
        </div>
      </div>
    </section>

    <!-- screen5: Job Details -->
    <section id="screen5" class="screen">
      <button class="btn-gray" onclick="go('screen4')">Back</button>
      <h2 id="job-title" class="section-title mt-3">Rambler Sparkling Water</h2>
      <p id="job-store" class="text-gray-500">Whole Foods Market</p>
      <p id="job-payout" class="text-2xl font-bold text-[#F9A825] mt-2">$3.00</p>
      <div class="sa-card p-4 mt-4">
        <h3 class="font-bold text-gray-800">Job Instructions</h3>
        <ul class="list-disc pl-5 text-gray-700 mt-2 space-y-1">
          <li>Go to the beverage aisle (sparkling water section).</li>
          <li>Take a photo of the shelf section (clear & well-lit).</li>
          <li>Take a photo of the price tag (readable price & barcode).</li>
        </ul>
      </div>
      <div class="sa-card p-4 mt-4">
        <label class="block text-sm font-medium text-gray-700">Confirm Shelf Price</label>
        <div class="mt-1 relative rounded-md shadow-sm">
          <span class="absolute inset-y-0 left-3 flex items-center text-gray-400">$</span>
          <input id="price-input" type="text" inputmode="decimal" placeholder="2.99"
                 class="pl-7 pr-12 w-full border rounded py-2"/>
          <span class="absolute inset-y-0 right-3 flex items-center text-gray-400">USD</span>
        </div>
        <p class="text-xs text-gray-500 mt-1">Enter the number from the shelf tag (e.g., 2.99).</p>
      </div>
      <div class="mt-4">
        <button class="w-full btn-red" onclick="go('screen6')">Start Job</button>
      </div>
    </section>

    <!-- screen6: Photo Capture -->
    <section id="screen6" class="screen bg-black text-white">
      <button class="btn-gray" onclick="go('screen5')">Back</button>
      <div class="mt-6 w-full max-w-sm mx-auto bg-white text-black p-4 rounded-lg">
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium">Photo Input Mode</label>
          <button id="mode-toggle" class="px-2 py-1 border rounded" onclick="togglePhotoMode()">Use Auto Demo</button>
        </div>
        <div class="mb-2 text-xs">
          <label class="mr-2">Demo Set:</label>
          <select id="demo-set" class="border rounded px-2 py-1" onchange="setDemoSet(this.value)">
            <option value="coffee">Peet's Coffee (default)</option>
            <option value="sparkling">Sparkling Water Shelf</option>
          </select>
        </div>
        <div id="upload-block">
          <label class="block text-sm font-medium mb-1">Upload or take a photo</label>
          <input id="photo-input" type="file" accept="image/*" capture="environment" class="w-full text-sm"/>
        </div>
        <div id="photo-preview" class="mt-3 w-full h-40 bg-gray-200 rounded flex items-center justify-center text-gray-500">No photo selected</div>
        <button class="mt-3 w-full btn-red" onclick="proceedToAnalysis()">Use This Photo</button>
        <p class="text-xs text-gray-600 mt-2">Tip: Auto Demo loads sample images for quick walkthroughs.</p>
      </div>
      <div class="text-center mt-6">
        <div class="w-24 h-24 rounded-full bg-gray-600 mx-auto flex items-center justify-center">
          <span class="text-gray-300">Cam</span>
        </div>
        <p class="mt-2">Take Photo 1 of 2 ‚Äî Shelf Section</p>
      </div>
    </section>

    <!-- screen7: Analysis -->
    <section id="screen7" class="screen">
      <h2 class="section-title">Uploading & Analyzing...</h2>
      <p class="text-gray-500">This should only take a few seconds.</p>
      <div class="loading mt-4"></div>

      <div class="sa-card p-4 mt-5 border-l-4" style="border-left-color:var(--sa-red)">
        <p class="font-bold">Checking...</p>
        <p class="text-sm text-gray-500 mt-1">‚úì Proper lighting</p>
        <p class="text-sm text-gray-500">‚úì In-focus</p>
        <p class="text-sm text-gray-500">‚úì Visible product</p>
      </div>

      <div class="sa-card p-4 mt-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold">Analysis (beta)</h3>
          <button class="btn-gray" onclick="runVisionAnalysis()">Analyze This Photo</button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Prototype only: populates a structured summary.</p>
        <div id="vision-results" class="mt-3 text-sm"></div>
      </div>

      <div class="mt-6 flex gap-3">
        <button class="flex-1 btn-gray" onclick="go('screen6')">Back</button>
        <button class="flex-1 btn-red" onclick="submitJob()">Submit for Review</button>
      </div>
    </section>

    <!-- screen8: Client Dashboard -->
    <section id="screen8" class="screen">
      <h2 class="section-title">Client Dashboard</h2>
      <p class="text-gray-500">Real-time data at your fingertips</p>
      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="sa-card p-4 border-l-4" style="border-left-color:#4285F4">
          <p class="text-sm text-gray-500">Shelf Presence Score</p><p class="text-2xl font-bold">89%</p><p class="text-xs text-gray-500">Planogram ‚Ä¢ Facings ‚Ä¢ Tidiness</p>
        </div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:var(--sa-red)">
          <p class="text-sm text-gray-500">Out-of-Stock Alerts</p><p class="text-2xl font-bold">üö®</p><p class="text-xs text-gray-500">Whole Foods, Houston</p>
        </div>
      </div>

      <div class="sa-card p-4 mt-4">
        <h3 class="font-bold">Recent Audits</h3>
        <div class="grid grid-cols-3 gap-2 mt-2">
          <div class="h-20 bg-gray-200 rounded"></div><div class="h-20 bg-gray-200 rounded"></div><div class="h-20 bg-gray-200 rounded"></div>
          <div class="h-20 bg-gray-200 rounded"></div><div class="h-20 bg-gray-200 rounded"></div><div class="h-20 bg-gray-200 rounded"></div>
        </div>
      </div>

      <div class="sa-card p-4 mt-4 border-l-4" style="border-left-color:#34A853">
        <p class="text-sm text-gray-500">Latest Reported Shelf Price</p>
        <p class="text-2xl font-bold">$<span id="reported-price">‚Äî</span></p>
        <p class="text-xs text-gray-500"><span id="reported-price-location">Location pending</span></p>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <button class="btn-red" onclick="go('screen13')">Create New Job</button>
        <button class="btn-gray" onclick="buildReportFromState(); injectReportAnalysis(); go('screen19')">Open Client Snapshot</button>
      </div>

      <div class="sa-card p-4 mt-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold">Jobs Map</h3>
          <button class="px-3 py-1 border rounded" onclick="toggleMapMode()">Toggle Live Map</button>
        </div>
        <div id="map-static" class="mt-2">
          <img class="w-full h-44 object-cover rounded" src="https://upload.wikimedia.org/wikipedia/commons/5/5c/BlankMap-World-v2.png" alt="Map">
          <p class="text-xs text-gray-500 mt-1">Static placeholder shown offline.</p>
        </div>
        <div id="map-live" class="hidden mt-2">
          <iframe class="w-full h-44 rounded" loading="lazy" src="https://www.google.com/maps?q=Houston,+TX&output=embed"></iframe>
        </div>
      </div>
    </section>

    <!-- screen9: My Jobs -->
    <section id="screen9" class="screen">
      <h2 class="section-title">My Jobs</h2>
      <div class="mt-4 space-y-3">
        <div class="sa-card p-4 border-l-4" style="border-left-color:#10B981">
          <p class="font-bold">Rambler Sparkling Water</p><p class="text-sm text-gray-500">Completed at Whole Foods Market</p><p class="text-sm text-green-600 font-bold">Earned $3.00</p>
        </div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:#F59E0B">
          <p class="font-bold">Neutral Milk</p><p class="text-sm text-gray-500">In progress at Whole Foods Market</p><p class="text-sm text-yellow-600 font-bold">Estimated: $3.00</p>
        </div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:#9CA3AF">
          <p class="font-bold">RIND Snacks</p><p class="text-sm text-gray-500">Pending approval</p><p class="text-sm text-gray-500 font-bold">Waiting</p>
        </div>
      </div>
      <div class="taskbar mt-6">
        <div class="flex justify-around text-gray-500">
          <button onclick="go('screen4')">Dashboard</button>
          <button class="font-bold text-[#C62828]">Jobs</button>
          <button onclick="go('screen10')">Brands</button>
          <button onclick="go('screen11')">Profile</button>
        </div>
      </div>
    </section>

    <!-- screen10: Brands (unchanged static grid + new dynamic list) -->
    <section id="screen10" class="screen">
      <h2 class="section-title">Brands</h2>
      <p class="text-gray-500">Explore participating brands & offers</p>
      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="sa-card brand-card cursor-pointer" onclick="openBrand('Rambler Sparkling Water','Rambler is a Texas-based sparkling water brand‚Ä¶')">
          <div class="logo">R</div><p class="font-bold mt-2">Rambler Sparkling Water</p><span class="value mt-1">Save 10%</span>
        </div>
        <div class="sa-card brand-card cursor-pointer" onclick="openBrand('Neutral Milk','Neutral partners with regenerative farmers to produce carbon-neutral dairy‚Ä¶')">
          <div class="logo">N</div><p class="font-bold mt-2">Neutral Milk</p><span class="value mt-1">Coupon</span>
        </div>
        <div class="sa-card brand-card cursor-pointer" onclick="openBrand('Peet\'s Coffee','Specialty coffee with hand‚Äëroasted beans and rich flavors‚Ä¶')">
          <div class="logo">PC</div><p class="font-bold mt-2">Peet's Coffee</p><span class="value mt-1">Explore</span>
        </div>
        <div class="sa-card brand-card cursor-pointer" onclick="openBrand('RIND Snacks','Upcycled whole‚Äëfruit snacks ‚Äî fiber‚Äërich & delicious‚Ä¶')">
          <div class="logo">RIND</div><p class="font-bold mt-2">RIND Snacks</p><span class="value mt-1">Save 15%</span>
        </div>
        <div class="sa-card brand-card cursor-pointer col-span-2" onclick="openBrand('Mana Foods','Organic foods from Hawaii using local sustainable ingredients‚Ä¶')">
          <div class="logo">MF</div><p class="font-bold mt-2">Mana Foods</p><span class="value mt-1">Explore</span>
        </div>
      </div>

      <!-- Your client brands (dynamic) -->
      <div class="mt-6">
        <h3 class="text-lg font-bold">Your client brands</h3>
        <p class="text-sm text-gray-500">Brands you saved from Admin ‚Üí Add Client.</p>
        <div id="your-brands" class="mt-3 space-y-2"></div>
      </div>

      <div class="taskbar mt-6">
        <div class="flex justify-around text-gray-500">
          <button onclick="go('screen4')">Dashboard</button>
          <button onclick="go('screen9')">Jobs</button>
          <button class="font-bold text-[#C62828]">Brands</button>
          <button onclick="go('screen11')">Profile</button>
        </div>
      </div>
    </section>

    <!-- screen11: Profile -->
    <section id="screen11" class="screen">
      <h2 class="section-title">My Profile</h2>
      <div class="mt-4 space-y-3">
        <div class="sa-card p-4"><p class="font-bold">Total Earnings</p><p class="text-2xl font-bold">$15.00</p></div>
        <div class="sa-card p-4"><p class="font-bold">Jobs Completed</p><p class="text-2xl font-bold">2</p></div>
        <div class="sa-card p-4"><p class="font-bold">Account</p><p class="text-sm text-gray-500">Courtney Bhenderu ‚Ä¢ courtney@example.com</p></div>
      </div>
      <div class="taskbar mt-6">
        <div class="flex justify-around text-gray-500">
          <button onclick="go('screen4')">Dashboard</button>
          <button onclick="go('screen9')">Jobs</button>
          <button onclick="go('screen10')">Brands</button>
          <button class="font-bold text-[#C62828]">Profile</button>
        </div>
      </div>
    </section>

    <!-- screen12: Brand Bio -->
    <section id="screen12" class="screen">
      <button class="btn-gray" onclick="go('screen10')">Back to Brands</button>
      <h2 id="brand-bio-title" class="section-title mt-3"></h2>
      <p id="brand-bio-text" class="text-gray-600 mt-2"></p>
    </section>

    <!-- screen13: Client ‚Äî Create New Job (tiers) -->
    <section id="screen13" class="screen">
      <h2 class="section-title">Create New Job</h2>
      <div class="mt-4 space-y-3">
        <div class="sa-card p-4 border-l-4" style="border-left-color:#10B981"><p class="font-bold">Standard Check</p><p class="text-sm text-gray-500">Core photos + AI within 48h</p></div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:#F59E0B"><p class="font-bold">Launch Day Bundle</p><p class="text-sm text-gray-500">Multiple stores within 24h</p></div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:#EF4444"><p class="font-bold">Rush Audit</p><p class="text-sm text-gray-500">Urgent photos within 6h</p></div>
      </div>
      <div class="mt-5 flex gap-3">
        <button class="flex-1 btn-red" onclick="go('screen20')">Select Job Type</button>
        <button class="flex-1 btn-gray" onclick="go('screen8')">Cancel</button>
      </div>
    </section>

    <!-- screen14: Admin Dashboard (adds only one new button) -->
    <section id="screen14" class="screen">
      <h2 class="section-title">Admin Dashboard</h2>
      <div class="mt-3">
        <button id="btnAddBrand" class="btn-red">Add Client</button>
      </div>
      <div class="mt-4 space-y-3">
        <div class="sa-card p-4"><p class="font-bold">New User Sign-ups</p><div class="flex justify-between"><p class="text-2xl font-bold">5</p><button class="btn-gray" onclick="go('screen15')">Review</button></div></div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:var(--sa-gold)"><p class="font-bold">Jobs to Approve</p><div class="flex justify-between"><p class="text-2xl font-bold">3</p><button class="btn-gray" onclick="go('screen16')">Review</button></div></div>
        <div class="sa-card p-4 border-l-4" style="border-left-color:var(--sa-red)"><p class="font-bold">Support Requests</p><div class="flex justify-between"><p class="text-2xl font-bold">1</p><button class="btn-gray" onclick="go('screen17')">View</button></div></div>
      </div>
    </section>

    <!-- screen15: Admin ‚Äî Users -->
    <section id="screen15" class="screen">
      <h2 class="section-title">Review New Users</h2>
      <div class="sa-card p-4 mt-4">
        <p class="font-bold">New User: Jane Doe</p>
        <p class="text-sm text-gray-500">Joined: Aug 28, 2025 ‚Äî Houston, TX</p>
        <div class="mt-3 flex gap-2">
          <button class="btn-red">Approve</button>
          <button class="btn-gray">Deny</button>
        </div>
      </div>
      <button class="mt-5 btn-gray" onclick="go('screen14')">Back to Admin Dashboard</button>
    </section>

    <!-- screen16: Admin ‚Äî Jobs -->
    <section id="screen16" class="screen">
      <h2 class="section-title">Review Job Submissions</h2>
      <div class="sa-card p-4 mt-4">
        <p class="font-bold">Job: Peet's Coffee ‚Äî H‚ÄëE‚ÄëB, Bridgeland</p>
        <div class="grid grid-cols-3 gap-2 mt-2">
          <div class="h-24 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">Aisle</div>
          <div class="h-24 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">Shelf</div>
          <div class="h-24 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">Tag</div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn-red">Approve</button>
          <button class="btn-gray">Reject</button>
        </div>
      </div>
      <button class="mt-5 btn-gray" onclick="go('screen14')">Back to Admin Dashboard</button>
    </section>

    <!-- screen17: Admin ‚Äî Support -->
    <section id="screen17" class="screen">
      <h2 class="section-title">Support Requests</h2>
      <div class="sa-card p-4 mt-4 border-l-4" style="border-left-color:var(--sa-red)">
        <p class="font-bold">From John Doe ‚Äî Peet's Coffee @ H‚ÄëE‚ÄëB</p>
        <p class="text-sm text-gray-600 mt-1">‚ÄúMy photos keep getting rejected. I can't figure out why.‚Äù</p>
        <div class="mt-3 flex gap-2">
          <button class="btn-red">Reply</button>
          <button class="btn-gray">Resolve</button>
        </div>
      </div>
      <button class="mt-5 btn-gray" onclick="go('screen14')">Back to Admin Dashboard</button>
    </section>

    <!-- screen19: Client Snapshot -->
    <section id="screen19" class="screen">
      <div class="sa-card p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-extrabold">ShelfAssured ‚Äî Client Snapshot</h2>
          <button class="btn-red" onclick="window.print()">Print / Save PDF</button>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-3">
          <div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500">Brand</p><p id="report-brand" class="font-semibold">‚Äî</p></div>
          <div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500">Store</p><p id="report-store" class="font-semibold">‚Äî</p></div>
          <div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500">Reported Shelf Price</p><p id="report-price" class="font-semibold">‚Äî</p></div>
          <div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500">Submitted</p><p id="report-date" class="font-semibold">‚Äî</p></div>
        </div>
        <div class="mt-4">
          <p class="font-semibold">Photos</p>
          <div id="report-photos" class="grid grid-cols-3 gap-2 mt-1"></div>
        </div>
        <div class="mt-4">
          <p class="font-semibold">Analysis Summary</p>
          <div id="report-analysis" class="text-sm text-gray-800 bg-gray-50 p-3 rounded">No analysis captured yet. Use <b>Analyze This Photo</b> on the Analysis screen.</div>
        </div>
      </div>
      <div class="mt-4"><button class="btn-gray" onclick="go('screen8')">Back to Client Dashboard</button></div>
    </section>

    <!-- screen20: Create Job (Form) ‚Äî unchanged layout, brand input enhanced with datalist -->
<section id="screen20" class="screen">
  <div class="sa-card p-4">
    <h2 class="section-title mb-2">Create New Job</h2>

    <!-- Brand -->
    <label class="block text-sm">Product / Brand</label>
    <input id="cj-brand" list="brandOptions" class="w-full border rounded px-3 py-2 mt-1" placeholder="Start typing a brand‚Ä¶"/>
    <datalist id="brandOptions"></datalist>

    <!-- Stores -->
    <div class="mt-4">
      <div class="flex items-center justify-between">
        <label class="block text-sm">Stores</label>
        <label class="text-xs flex items-center gap-2">
          <input id="cj-allstores" type="checkbox"/> All stores for this brand
        </label>
      </div>
      <input id="cj-store" list="brandStoresList" class="w-full border rounded px-3 py-2 mt-1" placeholder="Type a store to add‚Ä¶"/>
      <datalist id="brandStoresList"></datalist>
      <div class="text-xs text-gray-500 mt-1">Tip: choose from suggestions or type any store, then press Enter.</div>
      <div id="cj-store-chips" class="flex flex-wrap gap-2 mt-2"></div>
      <div id="sa-payout-hint" class="text-sm mt-2 hidden">
        <span class="font-medium">Payout hint:</span>
        <span id="sa-payout-hint-text">$0</span>
      </div>
      <script>
        (function () {
          var PER_STORE = 5;
          var chipsEl = document.getElementById('cj-store-chips');
          var inputEl = document.getElementById('cj-store');
          var allStoresEl = document.getElementById('cj-allstores');
          var hintEl = document.getElementById('sa-payout-hint');
          var hintTextEl = document.getElementById('sa-payout-hint-text');

          function getSelectedCount() {
            if (chipsEl) {
              return chipsEl.children ? chipsEl.children.length : 0;
            }
            return 0;
          }

          function updatePayoutHint() {
            var n = getSelectedCount();
            var all = allStoresEl && allStoresEl.checked;

            if (all && n === 0) {
              // Show hint even if no explicit stores when "all stores" is selected
              hintTextEl.textContent = '$' + PER_STORE + ' √ó all stores';
              hintEl.classList.remove('hidden');
              return;
            }

            if (n > 0) {
              var total = PER_STORE * n;
              var suffix = all ? ' (all stores)' : '';
              hintTextEl.textContent = '$' + PER_STORE + ' √ó ' + n + ' stores = $' + total + suffix;
              hintEl.classList.remove('hidden');
            } else {
              // Fallback: if user typed a value but no chip created yet, count as 1
              var typed = inputEl && inputEl.value && inputEl.value.trim().length > 0;
              if (typed) {
                var totalTyped = PER_STORE * 1;
                var suffixTyped = all ? ' (all stores)' : '';
                hintTextEl.textContent = '$' + PER_STORE + ' √ó 1 store = $' + totalTyped + suffixTyped;
                hintEl.classList.remove('hidden');
              } else {
                hintEl.classList.add('hidden');
              }
            }
          }

          // Observe changes to chips container (chips added/removed)
          if (window.MutationObserver && chipsEl) {
            var observer = new MutationObserver(updatePayoutHint);
            observer.observe(chipsEl, { childList: true, subtree: false });
          }

          // Listen to checkbox and input changes
          if (allStoresEl) {
            allStoresEl.addEventListener('change', updatePayoutHint);
          }
          if (inputEl) {
            inputEl.addEventListener('input', updatePayoutHint);
            inputEl.addEventListener('change', updatePayoutHint);
            inputEl.addEventListener('blur', updatePayoutHint);
            inputEl.addEventListener('keydown', function (e) {
              if (e.key === 'Enter') {
                // Defer to allow any chip-creation logic elsewhere to run first
                setTimeout(updatePayoutHint, 0);
              }
            });
          }

          // Initial render
          updatePayoutHint();
        })();
      </script>
    </div>

    <!-- SKUs -->
    <div class="mt-4">
      <label class="block text-sm">SKUs / Flavors</label>
      <input id="cj-sku" list="brandSkusList" class="w-full border rounded px-3 py-2 mt-1" placeholder="UPC or name (choose to add)‚Ä¶"/>
      <datalist id="brandSkusList"></datalist>
      <div class="text-xs text-gray-500 mt-1">Pick one, press Enter. Repeat to add multiple flavors.</div>
      <div id="cj-sku-chips" class="flex flex-wrap gap-2 mt-2"></div>
    </div>

    <!-- Category (optional helper for later) -->
    <div class="mt-4">
      <label class="block text-sm">Category <span class="text-gray-500 text-xs">(optional)</span></label>
      <input id="cj-category" list="brandCategoriesList" class="w-full border rounded px-3 py-2 mt-1" placeholder="e.g., Beverages / Water"/>
      <datalist id="brandCategoriesList"></datalist>
    </div>

    <!-- Type + Notes -->
    <label class="block text-sm mt-4">Job Type</label>
    <div class="mt-1 space-y-1">
      <label class="flex items-center gap-2"><input type="radio" name="cj-type" value="standard" checked> <span>Standard Check ‚Äî core photos within 48h</span></label>
      <label class="flex items-center gap-2"><input type="radio" name="cj-type" value="launch"> <span>Launch Day Bundle ‚Äî multiple stores within 24h</span></label>
      <label class="flex items-center gap-2"><input type="radio" name="cj-type" value="rush"> <span>Rush Audit ‚Äî urgent photos within 6h</span></label>
    </div>

    <label class="block text-sm mt-3">Photo Instructions</label>
    <textarea id="cj-notes" rows="3" class="w-full border rounded px-3 py-2 mt-1" placeholder="e.g., Close-up of price tag (price + barcode must be readable)."></textarea>

    <!-- Payout hint -->
    <div id="cj-payout-hint" class="mt-3 text-sm text-gray-700"></div>

    <div class="flex gap-3 mt-4">
      <button class="btn-red" onclick="publishJob()">Publish Job</button>
      <button class="btn-gray" onclick="go('screen8')">Cancel</button>
    </div>
  </div>
</section>

    <!-- screen21: Add Client (new, gentle form) -->
  <section id="screen21" class="screen">
  <h2 class="section-title">Add Client Brand</h2>
  <p class="text-gray-500">Only the brand name is required. You can add more details anytime.</p>

  <div class="sa-card p-4 mt-3">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm mb-1">Brand name *</label>
        <input id="ab_name" class="w-full border rounded px-3 py-2" placeholder="Rambler"/>
      </div>
      <div>
        <label class="block text-sm mb-1">Logo URL <span class="text-gray-500 text-xs">(optional)</span></label>
        <input id="ab_logo" class="w-full border rounded px-3 py-2" placeholder="https://..."/>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
      <div>
        <label class="block text-sm mb-1">Contact name</label>
        <input id="ab_cname" class="w-full border rounded px-3 py-2" placeholder="Alex"/>
      </div>
      <div>
        <label class="block text-sm mb-1">Contact email</label>
        <input id="ab_cemail" type="email" class="w-full border rounded px-3 py-2" placeholder="alex@brand.com"/>
      </div>
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">
        Stores <span class="text-gray-500 text-xs">(one per line)</span>
      </label>
      <textarea id="ab_stores" rows="4" class="w-full border rounded px-3 py-2" placeholder="H-E-B - 20017 Bridgeland Creek Pkwy, Cypress, TX 77433
Whole Foods Market - 10133 Louetta Rd, Houston, TX 77070"></textarea>
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">
        SKUs <span class="text-gray-500 text-xs">(CSV lines: UPC,Name[,Flavor][,ImgURL])</span>
      </label>
      <textarea id="ab_skus" rows="4" class="w-full border rounded px-3 py-2" placeholder="012345678905,Rambler Sparkling Water,Lime
012345678906,Rambler Sparkling Water,Cherry,https://example.com/img.jpg"></textarea>
      <div id="ab_skus_note" class="text-xs text-gray-500 mt-1"></div>
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">
        Categories <span class="text-gray-500 text-xs">(comma separated)</span>
      </label>
      <input id="ab_categories" class="w-full border rounded px-3 py-2" placeholder="Beverages, Water"/>
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">Default tasks <span class="text-gray-500 text-xs">(comma separated)</span></label>
      <input id="ab_tasks" class="w-full border rounded px-3 py-2" placeholder="front photo, price, facing count"/>
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">Notes <span class="text-gray-500 text-xs">(optional)</span></label>
      <textarea id="ab_notes" class="w-full border rounded px-3 py-2" rows="3" placeholder="Anything helpful for the shopper..."></textarea>
    </div>

    <div class="flex gap-2 mt-4">
      <button id="ab_save" class="btn-red">Save</button>
      <button id="ab_cancel" class="btn-gray">Cancel</button>
    </div>
  </div>

  <div class="mt-4">
    <button class="btn-gray" onclick="go('screen14')">Back to Admin Dashboard</button>
  </div>
</section>

  </div>
</div>

<script>
(function(){
  // ----- SAFETY: only add if not already present -----
  if (typeof window.saGet === 'function') return;

  window.saGet = function(key, fallback=null){
    try { return JSON.parse(localStorage.getItem(key)); }
    catch(e){ return localStorage.getItem(key) || fallback; }
  };
  window.saSet = function(key, val){
    try { localStorage.setItem(key, JSON.stringify(val)); }
    catch(e){ localStorage.setItem(key, val); }
  };
  window.isUPC = str => /^[0-9]{8,14}$/.test(str||'');
  window.isPrice = str => /^[0-9]+(\.[0-9]{1,2})?$/.test(str||'');
  window.uniq = arr => [...new Set(arr||[])];
})();
// --- basic navigation + nav dropdown ---
function go(id){
  closeNav();
  const el = document.getElementById(id);
  if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
}
const menuBtn = document.getElementById('menuBtn');
const quickNav = document.getElementById('quickNav');
const navMask = document.getElementById('navMask');
function openNav(){ quickNav.classList.add('open'); navMask.classList.add('open'); }
function closeNav(){ quickNav.classList.remove('open'); navMask.classList.remove('open'); }
menuBtn.addEventListener('click', ()=> quickNav.classList.contains('open') ? closeNav() : openNav());
navMask.addEventListener('click', closeNav);
quickNav.addEventListener('click', (e)=>{
  const btn=e.target.closest('button[data-goto]'); if(!btn) return;
  go(btn.dataset.goto);
});
window.addEventListener('scroll', ()=> closeNav());

// --- state keys ---
var SA = {
  earningsKey:'sa_earnings', jobsKey:'sa_jobs_completed',
  priceKey:'sa_last_price', storeKey:'sa_last_store',
  brandKey:'sa_last_brand', photoKey:'sa_last_photo',
  submittedAtKey:'sa_last_submitted_at'
};
function initState(){
  if (localStorage.getItem(SA.earningsKey)===null) localStorage.setItem(SA.earningsKey,'1500');
  if (localStorage.getItem(SA.jobsKey)===null) localStorage.setItem(SA.jobsKey,'2');
  // wire Admin "Add Client" button
  document.getElementById('btnAddBrand')?.addEventListener('click', ()=> go('screen21'));
  syncClientUI(); renderJobsPool(); updateJobDetailsUI();
  // brand helpers
  populateBrandDatalist();
  renderClientBrands();
  wireAddBrandForm();
}
function syncClientUI(){
  const price = localStorage.getItem(SA.priceKey);
  const store = localStorage.getItem(SA.storeKey);
  const rp = document.getElementById('reported-price');
  const rpl = document.getElementById('reported-price-location');
  if (rp) rp.textContent = price ? price : '‚Äî';
  if (rpl) rpl.textContent = store ? store : 'Location pending';
}
function setJob(brand, store, payoutCents){
  localStorage.setItem('sa_current_job_brand', brand||'');
  localStorage.setItem('sa_current_job_store', store||'');
  localStorage.setItem('sa_current_job_payout', String(payoutCents||300));
  updateJobDetailsUI();
}
function updateJobDetailsUI(){
  var brand = localStorage.getItem('sa_current_job_brand') || 'Rambler Sparkling Water';
  var store = localStorage.getItem('sa_current_job_store') || 'Whole Foods Market';
  var payout = parseInt(localStorage.getItem('sa_current_job_payout')||'300',10);
  document.getElementById('job-title').textContent = brand;
  document.getElementById('job-store').textContent = store;
  document.getElementById('job-payout').textContent = '$'+(payout/100).toFixed(2);
}
// --- photo demo ---
window.autoDemoMode=false; window.demoPhotos=['demo_peets_aisle.jpg','demo_peets_shelf.jpg'];
function togglePhotoMode(){
  window.autoDemoMode=!window.autoDemoMode;
  document.getElementById('mode-toggle').textContent = window.autoDemoMode?'Use Upload Mode':'Use Auto Demo';
  document.getElementById('upload-block').style.display = window.autoDemoMode?'none':'block';
  if(window.autoDemoMode){ loadDemoPhoto(); }
}
function setDemoSet(v){
  if(v==='sparkling'){ window.demoPhotos=['demo_sparkling_aisle.jpg']; }
  else { window.demoPhotos=['demo_peets_aisle.jpg','demo_peets_shelf.jpg']; }
  if(window.autoDemoMode){ loadDemoPhoto(); }
}
function loadDemoPhoto(){
  const preview=document.getElementById('photo-preview');
  preview.innerHTML=''; const img=document.createElement('img');
  img.src=window.demoPhotos[0]; img.className='max-h-40 object-contain'; preview.appendChild(img);
  localStorage.setItem(SA.photoKey, img.src); localStorage.setItem('sa_last_photo_name', img.src.split('/').pop());
}
document.addEventListener('change', function(e){
  if (e.target && e.target.id==='photo-input' && e.target.files && e.target.files[0]){
    const reader=new FileReader();
    reader.onload=function(ev){
      const preview=document.getElementById('photo-preview');
      preview.innerHTML=''; const img=document.createElement('img');
      img.src=ev.target.result; img.className='max-h-40 object-contain'; preview.appendChild(img);
      localStorage.setItem(SA.photoKey, img.src); localStorage.setItem('sa_last_photo_name','upload.jpg');
    };
    reader.readAsDataURL(e.target.files[0]);
  }
});
function proceedToAnalysis(){ if(window.autoDemoMode){ loadDemoPhoto(); } go('screen7'); }

// --- analysis demo ---
function runVisionAnalysis(){
  const box=document.getElementById('vision-results'); if(!box) return;
  const name = (localStorage.getItem('sa_last_photo_name')||'').toLowerCase();
  if(name.includes('sparkling')){
    box.innerHTML = '<b>Detected brands:</b> bubly, Rambler, Topo Chico (approx.)'
      + '<div class="mt-2 text-xs text-gray-600">Counts rough; pricing OCR not enabled in MVP.</div>';
  } else {
    box.textContent = 'Demo summary for coffee aisle set (placeholder logic).';
  }
  localStorage.setItem('sa_last_analysis_html', box.innerHTML);
}
function injectReportAnalysis(){
  const ana = localStorage.getItem('sa_last_analysis_html');
  const box = document.getElementById('report-analysis');
  if (ana && box) box.innerHTML = ana;
}

// --- submit / price validation (robust) ---
function getPriceValue(){
  const raw = (document.getElementById('price-input')?.value||'').trim();
  const normalized = raw.replace(/[^0-9.]/g,''); // strip $ and spaces
  return normalized;
}
function submitJob(){
  const val = getPriceValue();
  if (!/^[0-9]+(\.[0-9]{1,2})?$/.test(val)){
    alert('Please enter a valid shelf price, e.g., 2.99');
    go('screen5'); // send back to price field for clarity
    return;
  }
  localStorage.setItem(SA.priceKey, val);
  const store = localStorage.getItem('sa_current_job_store') || 'Unknown store';
  localStorage.setItem(SA.storeKey, store);
  const brand = localStorage.getItem('sa_current_job_brand') || 'Rambler Sparkling Water';
  localStorage.setItem(SA.brandKey, brand);
  localStorage.setItem(SA.submittedAtKey, String(Date.now()));
  // earnings & jobs counters
  const e = parseInt(localStorage.getItem(SA.earningsKey)||'0',10); localStorage.setItem(SA.earningsKey, String(e+300));
  const j = parseInt(localStorage.getItem(SA.jobsKey)||'0',10); localStorage.setItem(SA.jobsKey, String(j+1));
  syncClientUI();
  go('screen9');
}

// --- report builder ---
function buildReportFromState(){
  const brand = localStorage.getItem(SA.brandKey) || '‚Äî';
  const store = localStorage.getItem(SA.storeKey) || '‚Äî';
  const price = localStorage.getItem(SA.priceKey) || '‚Äî';
  const when = localStorage.getItem(SA.submittedAtKey);
  const fmt = when ? (new Date(parseInt(when,10))).toLocaleString() : '‚Äî';
  document.getElementById('report-brand').textContent = brand;
  document.getElementById('report-store').textContent = store;
  document.getElementById('report-price').textContent = price==='‚Äî' ? '‚Äî' : '$'+price;
  document.getElementById('report-date').textContent = fmt;
  const photo = localStorage.getItem(SA.photoKey);
  const box = document.getElementById('report-photos'); box.innerHTML='';
  if (photo){ const img=document.createElement('img'); img.src=photo; img.className='w-full h-24 object-cover rounded'; box.appendChild(img); }
}

// --- brands (Add Client + datalist + dynamic list) ---
const BRANDS_KEY = 'sa_brands';
function listBrands(){ try{ return JSON.parse(localStorage.getItem(BRANDS_KEY)||'[]'); }catch(e){ return []; } }
function saveBrands(arr){ localStorage.setItem(BRANDS_KEY, JSON.stringify(arr||[])); }
function createBrand({name, logoUrl='', contactName='', contactEmail='', defaultTasks=[], notes='', stores=[], skus=[], categories=[]}){
  const all = listBrands();
  const brand = {
    id: 'brand_'+Date.now(),
    name: (name||'').trim(),
    logoUrl: (logoUrl||'').trim(),
    contactName: (contactName||'').trim(),
    contactEmail: (contactEmail||'').trim(),
    defaultTasks,
    notes,
    // NEW fields
    stores: stores || [],
    skus: skus || [], // [{upc,name,flavor?,imgUrl?}]
    categories: categories || []
  };
  all.unshift(brand); saveBrands(all);
  window.dispatchEvent(new CustomEvent('sa:brands-updated', { detail: brand }));
  return brand;
}
function populateBrandDatalist(){
  const dl = document.getElementById('brandOptions');
  if(!dl) return;
  const brands = listBrands();
  dl.innerHTML = brands.map(function(b){
    return '<option value=\"'+(b.name||'')+'\"></option>';
  }).join('');
}
function renderClientBrands(){
  const mount = document.getElementById('your-brands');
  if(!mount) return;
  const brands = listBrands();
  if(!brands.length){
    mount.innerHTML = '<div class=\"text-gray-600 text-sm\">No saved clients yet. Add one from Admin ‚Üí Add Client.</div>';
    return;
  }
  var html = '';
  for (var i=0;i<brands.length;i++){
    var b = brands[i];
    var contact = (b.contactName||'') + ((b.contactEmail && b.contactEmail.trim()) ? ((b.contactName?' ¬∑ ':'')+b.contactEmail) : '');
    var right = b.logoUrl && b.logoUrl.trim()
      ? '<img src=\"'+b.logoUrl+'\" alt=\"'+(b.name||'')+' logo\" class=\"w-8 h-8 rounded\">'
      : '<div class=\"w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-gray-400\">üè∑Ô∏è</div>';
    html += ''+
    '<div class=\"sa-card p-3 flex items-center justify-between border-l-4\" style=\"border-left-color: var(--sa-gold)\">'+
      '<div class=\"min-w-0 pr-3\">'+
        '<div class=\"font-bold truncate\">'+(b.name||'')+'</div>'+
        '<div class=\"text-xs text-gray-500 truncate\">'+(contact||'')+'</div>'+
      '</div>'+
      right+
    '</div>';
  }
  mount.innerHTML = html;
}
// Wire Add Client form
function wireAddBrandForm(){
  const saveBtn = document.getElementById('ab_save');
  const cancelBtn = document.getElementById('ab_cancel');
  if(!saveBtn || !cancelBtn) return;
// === CREATE JOB helpers (multi-store + multi-SKU) ===
let CJ_SELECTED_STORES = [];   // array of store strings (we‚Äôll also save as storeIds later if you adopt IDs)
let CJ_SELECTED_UPCS   = [];   // array of UPC strings for expectedUpcs
let CJ_ACTIVE_BRAND    = null; // brand object

function findBrandByName(name){
  const all = listBrands();
  const ix = all.findIndex(b => (b.name||'').toLowerCase() === (name||'').toLowerCase());
  return ix >= 0 ? all[ix] : null;
}

function onBrandChosen(name){
  CJ_ACTIVE_BRAND = findBrandByName(name);
  // reset selections
  CJ_SELECTED_STORES = [];
  CJ_SELECTED_UPCS = [];
  renderStoreChips();
  renderSkuChips();
  // fill datalists
  const storesDL = document.getElementById('brandStoresList');
  const skusDL   = document.getElementById('brandSkusList');
  const catsDL   = document.getElementById('brandCategoriesList');
  if(storesDL) storesDL.innerHTML = (CJ_ACTIVE_BRAND?.stores||[]).map(s=>`<option value="${s}"></option>`).join('');
  if(skusDL) {
    const rows = (CJ_ACTIVE_BRAND?.skus||[]).map(s=>{
      const label = [s.name, s.flavor].filter(Boolean).join(' ‚Äî ');
      return `<option value="${s.upc}">${label}</option>`;
    }).join('');
    skusDL.innerHTML = rows;
  }
  if(catsDL) catsDL.innerHTML = (CJ_ACTIVE_BRAND?.categories||[]).map(c=>`<option value="${c}"></option>`).join('');
  updatePayoutHint();
}

function addStoreFromInput(){
  const inp = document.getElementById('cj-store');
  const val = (inp.value||'').trim();
  if(!val) return;
  if(!CJ_SELECTED_STORES.includes(val)) CJ_SELECTED_STORES.push(val);
  inp.value = '';
  renderStoreChips(); updatePayoutHint();
}

function toggleAllStores(on){
  CJ_SELECTED_STORES = on ? [...(CJ_ACTIVE_BRAND?.stores||[])] : [];
  renderStoreChips(); updatePayoutHint();
}

function removeStore(val){
  CJ_SELECTED_STORES = CJ_SELECTED_STORES.filter(s=>s!==val);
  // Uncheck ‚Äúall stores‚Äù if user removes any
  const allChk = document.getElementById('cj-allstores');
  if(allChk && allChk.checked) allChk.checked = false;
  renderStoreChips(); updatePayoutHint();
}

function renderStoreChips(){
  const mount = document.getElementById('cj-store-chips');
  if(!mount) return;
  mount.innerHTML = CJ_SELECTED_STORES.map(s=>
    `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-sm">
       ${s}
       <button class="text-gray-500" onclick="removeStore('${s.replace(/'/g,"\\'")}')">‚úï</button>
     </span>`
  ).join('');
}

function addSkuFromInput(){
  const inp = document.getElementById('cj-sku');
  let val = (inp.value||'').trim();
  if(!val) return;
  // allow name entry ‚Üí map to UPC if matches brand SKUs
  if(!window.isUPC(val) && CJ_ACTIVE_BRAND?.skus?.length){
    const match = CJ_ACTIVE_BRAND.skus.find(s => [s.name, s.flavor].filter(Boolean).join(' ‚Äî ').toLowerCase() === val.toLowerCase());
    if(match) val = match.upc;
  }
  if(!window.isUPC(val)){ alert('Please enter a valid UPC or pick from the list.'); return; }
  if(!CJ_SELECTED_UPCS.includes(val)) CJ_SELECTED_UPCS.push(val);
  inp.value = '';
  renderSkuChips();
}

function removeSku(upc){
  CJ_SELECTED_UPCS = CJ_SELECTED_UPCS.filter(u=>u!==upc);
  renderSkuChips();
}

function renderSkuChips(){
  const mount = document.getElementById('cj-sku-chips');
  if(!mount) return;
  const nameFor = (u)=>{
    const rec = CJ_ACTIVE_BRAND?.skus?.find(s=>s.upc===u);
    return rec ? [rec.name, rec.flavor].filter(Boolean).join(' ‚Äî ') : u;
    };
  mount.innerHTML = CJ_SELECTED_UPCS.map(u=>
    `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-yellow-100 text-sm">
       ${nameFor(u)}
       <button class="text-gray-600" onclick="removeSku('${u}')">‚úï</button>
     </span>`
  ).join('');
}

function updatePayoutHint(){
  // Simple current rule: $5 per store (flat), regardless of SKUs
  const perStoreCents = 500;
  const n = CJ_SELECTED_STORES.length || 0;
  const total = n * perStoreCents;
  const el = document.getElementById('cj-payout-hint');
  if(el) el.textContent = n ? `$5 √ó ${n} store(s) = $${(total/100).toFixed(2)}` : 'Select at least one store.';
}

// Wire inputs (on first DOM ready)
document.addEventListener('DOMContentLoaded', ()=>{
  const brandInput = document.getElementById('cj-brand');
  const storeInput = document.getElementById('cj-store');
  const skuInput   = document.getElementById('cj-sku');
  const allChk     = document.getElementById('cj-allstores');

  if(brandInput){
    brandInput.addEventListener('change', (e)=> onBrandChosen(e.target.value));
    brandInput.addEventListener('blur',   (e)=> onBrandChosen(e.target.value));
  }
  if(storeInput){
    storeInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); addStoreFromInput(); }
    });
    storeInput.addEventListener('change', ()=> addStoreFromInput());
  }
  if(skuInput){
    skuInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); addSkuFromInput(); }
    });
    skuInput.addEventListener('change', ()=> addSkuFromInput());
  }
  if(allChk){
    allChk.addEventListener('change', (e)=> toggleAllStores(e.target.checked));
  }
});
  function parseStores(raw){
    return (raw||'').split('\n').map(s=>s.trim()).filter(Boolean);
  }
  function parseSkus(raw){
    const rows = (raw||'').split('\n').map(s=>s.trim()).filter(Boolean);
    const out = []; let skipped = 0;
    rows.forEach(line=>{
      const parts = line.split(',').map(s=>s.trim());
      const upc = (parts[0]||'').replace(/[^0-9]/g,'');
      if(!window.isUPC(upc)){ skipped++; return; }
      const name = parts[1]||'';
      const flavor = parts[2]||'';
      const imgUrl = parts[3]||'';
      out.push({ upc, name, flavor, imgUrl });
    });
    const note = document.getElementById('ab_skus_note');
    if(note) note.textContent = skipped ? `Skipped ${skipped} invalid line(s).` : '';
    return out;
  }
  function parseCategories(raw){
    return window.uniq((raw||'').split(',').map(s=>s.trim()).filter(Boolean));
  }

  saveBtn.addEventListener('click', function(){
    const name = (document.getElementById('ab_name').value||'').trim();
    if(!name){ alert('Please enter a brand name.'); return; }

    const logoUrl = document.getElementById('ab_logo').value||'';
    const contactName = document.getElementById('ab_cname').value||'';
    const contactEmail = document.getElementById('ab_cemail').value||'';
    const tasksRaw = document.getElementById('ab_tasks').value||'';
    const notes = document.getElementById('ab_notes').value||'';
    const stores = parseStores(document.getElementById('ab_stores').value);
    const skus = parseSkus(document.getElementById('ab_skus').value);
    const categories = parseCategories(document.getElementById('ab_categories').value);
    const defaultTasks = (tasksRaw||'').split(',').map(s=>s.trim()).filter(Boolean);

    // Merge if brand already exists (case-insensitive)
    const all = listBrands();
    const ix = all.findIndex(b => (b.name||'').toLowerCase() === name.toLowerCase());
    if(ix >= 0){
      const doMerge = confirm('Brand exists. Merge new stores/SKUs/categories into it?');
      if(!doMerge) return;

      const existing = all[ix];

      // merge primitives if provided
      if(logoUrl) existing.logoUrl = logoUrl;
      if(contactName) existing.contactName = contactName;
      if(contactEmail) existing.contactEmail = contactEmail;
      if(defaultTasks.length) existing.defaultTasks = defaultTasks;
      if(notes) existing.notes = notes;

      // merge arrays
      existing.stores = window.uniq([...(existing.stores||[]), ...stores]);
      existing.categories = window.uniq([...(existing.categories||[]), ...categories]);

      // merge SKUs by UPC
      const byUPC = new Map((existing.skus||[]).map(s=>[s.upc, s]));
      (skus||[]).forEach(s=>{
        if(byUPC.has(s.upc)){
          const cur = byUPC.get(s.upc);
          // update missing fields only
          cur.name = s.name || cur.name;
          cur.flavor = s.flavor || cur.flavor;
          cur.imgUrl = s.imgUrl || cur.imgUrl;
        } else {
          byUPC.set(s.upc, s);
        }
      });
      existing.skus = Array.from(byUPC.values());

      all[ix] = existing;
      saveBrands(all);
      window.dispatchEvent(new CustomEvent('sa:brands-updated', { detail: existing }));
      alert('Brand updated.');
    } else {
      createBrand({ name, logoUrl, contactName, contactEmail, defaultTasks, notes, stores, skus, categories });
      alert('Client brand saved.');
    }

    // clear fields
    ['ab_name','ab_logo','ab_cname','ab_cemail','ab_stores','ab_skus','ab_categories','ab_tasks','ab_notes'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value='';
    });

    go('screen10'); // go to Brands
  });

  cancelBtn.addEventListener('click', function(){ go('screen14'); });
}


// --- job pool (create job form) ---
function getJobsPool(){ try{ return JSON.parse(localStorage.getItem('sa_jobs_pool')||'[]'); }catch(e){ return []; } }
function setJobsPool(arr){ try{ localStorage.setItem('sa_jobs_pool', JSON.stringify(arr||[])); } catch(e){} }
function renderJobsPool(){
  const mount=document.getElementById('jobs-dynamic'); if(!mount) return;
  const jobs=getJobsPool(); mount.innerHTML='';
  if(!jobs.length) return;
  // group by store
  const groups={}; jobs.forEach(function(j){ const k=j.store||'Other'; (groups[k]=groups[k]||[]).push(j); });
  Object.keys(groups).forEach(function(store){
    const head=document.createElement('div'); head.className='text-sm text-gray-700 bg-gray-100 rounded p-2 mt-2'; head.textContent=store; mount.appendChild(head);
    groups[store].forEach(function(job){
      const card=document.createElement('div'); card.className='sa-card p-4 cursor-pointer mt-1';
      card.innerHTML='<p class=\"font-bold\">'+(job.brand||'New Product')+'</p><p class=\"text-sm text-gray-500\">Take and upload 2 photos</p><p class=\"text-sm text-[#F9A825] font-semibold mt-1\">Earn $'+((job.payoutCents||300)/100).toFixed(2)+'</p>';
      card.onclick=function(){ setJob(job.brand, job.store, job.payoutCents||300); go('screen5'); };
      mount.appendChild(card);
    });
  });
}
function publishJob(){
  const brand = (document.getElementById('cj-brand').value||'').trim();
  const freeTypedStore = (document.getElementById('cj-store').value||'').trim(); // keep legacy primary field
  const type  = (document.querySelector('input[name="cj-type"]:checked')||{}).value || 'standard';
  const notes = (document.getElementById('cj-notes').value||'').trim();
  const category = (document.getElementById('cj-category')?.value||'').trim();

  if(!brand){ alert('Please pick a brand.'); return; }

  // selected stores: chips OR single field fallback
  let selectedStores = [...CJ_SELECTED_STORES];
  if(!selectedStores.length && freeTypedStore) selectedStores = [freeTypedStore];
  if(!selectedStores.length){ alert('Please add at least one store.'); return; }

  // selected UPCs: optional now, but recommended
  const expectedUpcs = [...CJ_SELECTED_UPCS]; // can be empty for legacy

  // payout calc (simple rule: $5/store)
  let payout = 500 * selectedStores.length;
  if(type==='launch') payout = Math.max(payout, 1200);
  if(type==='rush')   payout = Math.max(payout, 600);

  const primaryStore = selectedStores[0] || freeTypedStore || 'Unknown store';
  const job = {
    id:'job_'+Date.now(),
    brand,
    store: primaryStore,
    storeIds: selectedStores,     // strings for now
    expectedUpcs,                 // UPCs to verify at scan time
    category,
    type,
    payoutCents: payout,
    notes
  };

  const jobs = getJobsPool(); jobs.push(job); setJobsPool(jobs);
  setJob(brand, primaryStore, payout); // preserves your existing detail UI path
  go('screen4'); setTimeout(renderJobsPool, 50);

  // reset form UI
  CJ_SELECTED_STORES = []; CJ_SELECTED_UPCS = []; CJ_ACTIVE_BRAND = null;
  ['cj-brand','cj-store','cj-sku','cj-category','cj-notes'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  renderStoreChips(); renderSkuChips(); updatePayoutHint();
}
</script>

<script>
  // Supabase Configuration
  const SUPABASE_URL = 'https://mlmhmzhvwtsswigfvkwx.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sbWhtemh2d3Rzc3dpZ2Z2a3d4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NTYwNDQsImV4cCI6MjA3NDMzMjA0NH0.sr3x6TkgXlK4Nc8SHPwoS6q5TDGXeExfFK2vPoOTPYk';
  
  // Initialize Supabase
  let supabase;
  try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase client initialized');
  } catch (error) {
    console.error('‚ùå Supabase initialization failed:', error);
    supabase = null;
  }
  
  // Store original saGet/saSet functions as fallback
  const originalSaGet = window.saGet;
  const originalSaSet = window.saSet;
  
  // Enhanced saGet/saSet functions with Supabase integration
  window.saGet = async function(key, fallback = null) {
    // If Supabase is not available, use original function
    if (!supabase) {
      return originalSaGet ? originalSaGet(key, fallback) : fallback;
    }
    
    try {
      switch(key) {
        case 'brands':
          const { data: brands, error: brandsError } = await supabase
            .from('brands')
            .select('*')
            .eq('is_active', true)
            .order('name');
          if (brandsError) throw brandsError;
          return brands || fallback;
          
        case 'stores':
          const { data: stores, error: storesError } = await supabase
            .from('stores')
            .select('*')
            .eq('is_active', true)
            .order('name');
          if (storesError) throw storesError;
          return stores || fallback;
          
        case 'skus':
          const { data: skus, error: skusError } = await supabase
            .from('skus')
            .select('*')
            .eq('is_active', true)
            .order('name');
          if (skusError) throw skusError;
          return skus || fallback;
          
        case 'jobs':
          const { data: jobs, error: jobsError } = await supabase
            .from('jobs')
            .select(`
              *,
              brands(name),
              job_stores(store_id, stores(name, address)),
              job_skus(sku_id, skus(name, upc))
            `)
            .order('created_at', { ascending: false });
          if (jobsError) throw jobsError;
          return jobs || fallback;
          
        default:
          // Fallback to original function for other keys
          return originalSaGet ? originalSaGet(key, fallback) : fallback;
      }
    } catch (error) {
      console.error('Supabase Error:', error);
      // Fallback to original function on error
      return originalSaGet ? originalSaGet(key, fallback) : fallback;
    }
  };

  window.saSet = async function(key, val) {
    try {
      // For now, just store in localStorage as backup
      // In production, you'd want to save to Supabase
      if (originalSaSet) {
        return originalSaSet(key, val);
      } else {
        try { localStorage.setItem(key, JSON.stringify(val)); }
        catch(e){ localStorage.setItem(key, val); }
        return true;
      }
    } catch (error) {
      console.error('Storage Error:', error);
      return false;
    }
  };

  // Authentication functions
  window.saSignUp = async function(email, password, userData = {}) {
    if (!supabase) {
      return { success: false, error: 'Supabase not available' };
    }
    
    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: { data: userData }
      });
      
      if (error) throw error;
      
      // Create user profile
      if (data.user) {
        const { error: profileError } = await supabase
          .from('users')
          .insert([{
            id: data.user.id,
            email: userData.email,
            full_name: userData.fullName,
            phone: userData.phone,
            role: userData.role || 'contractor'
          }]);
        
        if (profileError) console.error('Profile creation error:', profileError);
      }
      
      return { success: true, data };
    } catch (error) {
      return { success: false, error: error.message };
    }
  };

  window.saSignIn = async function(email, password) {
    if (!supabase) {
      return { success: false, error: 'Supabase not available' };
    }
    
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) throw error;
      return { success: true, data };
    } catch (error) {
      return { success: false, error: error.message };
    }
  };

  window.saSignOut = async function() {
    if (!supabase) {
      return { success: false, error: 'Supabase not available' };
    }
    
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  };

  // Helper function for empty states
  window.saEmptyState = function(title, sub){
    return '<div class="rounded-2xl border p-6 text-center bg-white">' +
      '<div class="text-base font-medium">' + title + '</div>' +
      '<div class="text-sm text-gray-500 mt-1">' + sub + '</div>' +
      '</div>';
  };

  // Initialize app with Supabase
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ ShelfAssured initialized with Supabase!');
    
    // Check if user is logged in
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      console.log('‚úÖ User logged in:', user.email);
    } else {
      console.log('‚ÑπÔ∏è No user logged in');
    }
    
    // Load data from Supabase
    try {
      const brands = await saGet('brands', []);
      const stores = await saGet('stores', []);
      const jobs = await saGet('jobs', []);
      
      console.log('üìä Data loaded:', { 
        brands: brands.length, 
        stores: stores.length, 
        jobs: jobs.length 
      });
    } catch (error) {
      console.error('‚ùå Error loading data:', error);
    }
  });
</script>

</body>
</html>
