<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Dashboard - ShelfAssured</title>
    
    <!-- Set page role BEFORE loading shared/api.js -->
    <script>
        window.SA_PAGE_ROLE = 'admin'; // Admin can view brand dashboards
        window.SA_DISABLE_GLOBAL_GUARD = true;
        window.SA_ADMIN_READY = true;
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.5/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="../shared/styles.css">
</head>
<body>
    <div class="min-h-screen bg-gray-100">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <a href="../admin/dashboard.html" class="text-blue-600 hover:text-blue-800 flex items-center">
                            ‚Üê Back to Admin
                        </a>
                        <div class="h-6 border-l border-gray-300"></div>
                        <div class="flex items-center space-x-3">
                            <img id="brand-logo" src="" alt="Brand logo" 
                                 class="w-10 h-10 object-contain rounded border border-gray-200 bg-white hidden"
                                 onerror="this.style.display='none'">
                            <h1 class="text-2xl font-bold text-gray-900" id="brand-name">Brand Dashboard</h1>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="../admin/manage-jobs.html?brand_id=" id="create-job-btn" 
                           class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                            Create job
                        </a>
                        <button onclick="handleSignOut()" class="text-sm text-gray-500 hover:text-gray-700">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Error State (if brand ID missing/invalid) -->
            <div id="error-state" class="hidden bg-white rounded-lg shadow p-6">
                <div class="text-center">
                    <div class="text-red-600 text-2xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">Brand Not Found</h2>
                    <p class="text-gray-600 mb-4">The brand ID is missing or invalid.</p>
                    <a href="../admin/dashboard.html" class="text-blue-600 hover:text-blue-800 underline">Return to Admin Dashboard</a>
                </div>
            </div>

            <!-- Brand Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Active Jobs</h3>
                        <p class="text-3xl font-bold text-blue-600 mt-2" id="active-jobs">0</p>
                        <p class="text-sm text-gray-500 mt-1">Currently in progress</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Jobs Completed</h3>
                        <p class="text-3xl font-bold text-green-600 mt-2" id="completed-jobs">0</p>
                        <p class="text-sm text-gray-500 mt-1">Successful audits</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900">Total Products</h3>
                        <p class="text-3xl font-bold text-purple-600 mt-2" id="total-products">0</p>
                        <p class="text-sm text-gray-500 mt-1">Products monitored</p>
                    </div>
                </div>

                <!-- Brand Info -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Brand Information</h3>
                    <div class="flex items-start space-x-6 mb-4" id="brand-info-container">
                        <div class="w-24 h-24 flex items-center justify-center bg-gray-100 rounded-lg border border-gray-200 text-gray-400 text-sm text-center p-2">
                            No Logo
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Name</label>
                                <p class="text-gray-900 mt-1" id="brand-info-name">-</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Website</label>
                                <p class="text-gray-900 mt-1" id="brand-info-website">-</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Created</label>
                                <p class="text-gray-900 mt-1" id="brand-info-created">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Jobs -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Recent Jobs</h3>
                    </div>
                    <div id="recent-jobs" class="p-6">
                        <div class="text-center text-gray-500">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include shared API -->
    <script src="../shared/api.js?v=20250113-4"></script>
    
    <script>
        // Get brand ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const brandId = urlParams.get('id');
        
        let currentBrand = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîß Brand Dashboard initialized');
            console.log('Brand context:', brandId);
            
            if (!brandId) {
                showError('Brand ID is missing from URL');
                return;
            }
            
            // Update create job button URL
            const createJobBtn = document.getElementById('create-job-btn');
            if (createJobBtn) {
                createJobBtn.href = `../admin/manage-jobs.html?brand_id=${brandId}`;
            }
            
            // Load brand and dashboard data
            await loadBrandAndData();
        });

        // Load brand info and dashboard data
        async function loadBrandAndData() {
            try {
                // Load brand info
                const { data: brand, error: brandError } = await supabase
                    .from('brands')
                    .select('id, name, website, created_at, logo_url')
                    .eq('id', brandId)
                    .single();
                
                if (brandError || !brand) {
                    console.error('Error loading brand:', brandError);
                    showError('Brand not found or error loading brand');
                    return;
                }
                
                currentBrand = brand;
                console.log('Brand context:', brand.id, brand.name);
                
                // Update header with logo
                document.getElementById('brand-name').textContent = brand.name;
                const brandLogo = document.getElementById('brand-logo');
                if (brand.logo_url && brandLogo) {
                    // Fix URL encoding issues (spaces, etc.)
                    let logoUrl = brand.logo_url;
                    // Check if URL has unencoded spaces in bucket name path
                    if (logoUrl.includes('/brand logos/')) {
                        logoUrl = logoUrl.replace('/brand logos/', '/brand_logos/');
                        console.warn(`‚ö†Ô∏è Fixed logo URL space issue for ${brand.name}, replacing 'brand logos' with 'brand_logos'`);
                    }
                    // Encode any remaining spaces in the URL
                    logoUrl = encodeURI(logoUrl);
                    
                    console.log(`üé® Loading header logo for ${brand.name}: ${logoUrl.substring(0, 100)}...`);
                    brandLogo.src = logoUrl;
                    brandLogo.classList.remove('hidden');
                    brandLogo.onerror = function() {
                        console.error('‚ùå Header logo failed to load for', brand.name);
                        console.error('   Full URL:', logoUrl);
                        console.error('   Image naturalWidth:', this.naturalWidth, 'naturalHeight:', this.naturalHeight);
                        console.error('   Image complete:', this.complete);
                        // Try to fetch the URL to see what error we get
                        fetch(logoUrl)
                            .then(response => {
                                console.error('   Fetch status:', response.status, response.statusText);
                                return response.text();
                            })
                            .catch(error => {
                                console.error('   Fetch error:', error.message);
                            });
                        this.style.display = 'none';
                    };
                    brandLogo.onload = function() {
                        console.log('‚úÖ Header logo loaded successfully for', brand.name);
                    };
                }
                
                // Update brand info section
                document.getElementById('brand-info-name').textContent = brand.name || '-';
                document.getElementById('brand-info-website').innerHTML = brand.website ? 
                    `<a href="${escapeHtml(brand.website)}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">${escapeHtml(brand.website)}</a>` : '-';
                document.getElementById('brand-info-created').textContent = brand.created_at ? 
                    new Date(brand.created_at).toLocaleDateString() : '-';
                
                // Update brand info logo
                const brandInfoContainer = document.getElementById('brand-info-container');
                if (brandInfoContainer) {
                    if (brand.logo_url) {
                        // Fix URL encoding issues (spaces, etc.)
                        let logoUrl = brand.logo_url;
                        // Check if URL has unencoded spaces in bucket name path
                        if (logoUrl.includes('/brand logos/')) {
                            logoUrl = logoUrl.replace('/brand logos/', '/brand_logos/');
                            console.warn(`‚ö†Ô∏è Fixed brand info logo URL space issue for ${brand.name}`);
                        }
                        // Encode any remaining spaces in the URL
                        logoUrl = encodeURI(logoUrl);
                        
                        console.log(`üé® Loading brand info logo for ${brand.name}: ${logoUrl.substring(0, 100)}...`);
                        brandInfoContainer.innerHTML = `
                            <img src="${escapeHtml(logoUrl)}" alt="${escapeHtml(brand.name)} logo" 
                                 class="w-24 h-24 object-contain rounded-lg border border-gray-200 bg-white p-2"
                                 onerror="this.parentElement.innerHTML='<div class=\\'w-24 h-24 flex items-center justify-center bg-gray-100 rounded-lg border border-gray-200 text-gray-400 text-sm text-center p-2\\'>No Logo</div><div class=\\'grid grid-cols-1 md:grid-cols-2 gap-4 flex-1\\'><div><label class=\\'text-sm font-medium text-gray-700\\'>Name</label><p class=\\'text-gray-900 mt-1\\' id=\\'brand-info-name\\'>-</p></div><div><label class=\\'text-sm font-medium text-gray-700\\'>Website</label><p class=\\'text-gray-900 mt-1\\' id=\\'brand-info-website\\'>-</p></div><div><label class=\\'text-sm font-medium text-gray-700\\'>Created</label><p class=\\'text-gray-900 mt-1\\' id=\\'brand-info-created\\'>-</p></div></div>'">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Name</label>
                                    <p class="text-gray-900 mt-1" id="brand-info-name">${escapeHtml(brand.name || '-')}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Website</label>
                                    <p class="text-gray-900 mt-1" id="brand-info-website">${brand.website ? 
                                        `<a href="${escapeHtml(brand.website)}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">${escapeHtml(brand.website)}</a>` : '-'}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Created</label>
                                    <p class="text-gray-900 mt-1" id="brand-info-created">${brand.created_at ? new Date(brand.created_at).toLocaleDateString() : '-'}</p>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Show dashboard content
                document.getElementById('dashboard-content').classList.remove('hidden');
                
                // Load dashboard data (scoped to this brand)
                await loadDashboardData(brand.id);
                
            } catch (error) {
                console.error('Error loading brand data:', error);
                showError('Failed to load brand data');
            }
        }

        // Load dashboard data scoped to brand_id
        async function loadDashboardData(brandId) {
            try {
                // Load jobs for this brand
                const { data: jobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('id, title, status, created_at')
                    .eq('brand_id', brandId)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (jobsError) {
                    console.error('Error loading jobs:', jobsError);
                }
                
                const jobsList = jobs || [];
                
                // Update stats
                const activeJobs = jobsList.filter(j => j.status === 'pending' || j.status === 'in_progress').length;
                const completedJobs = jobsList.filter(j => j.status === 'completed').length;
                
                document.getElementById('active-jobs').textContent = activeJobs;
                document.getElementById('completed-jobs').textContent = completedJobs;
                
                // Load products for this brand
                const { data: products, error: productsError } = await supabase
                    .from('brand_products')
                    .select('id')
                    .eq('brand_id', brandId);
                
                if (productsError) {
                    console.error('Error loading products:', productsError);
                }
                
                const productsCount = products?.length || 0;
                document.getElementById('total-products').textContent = productsCount;
                
                // Display recent jobs
                displayRecentJobs(jobsList.slice(0, 10));
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Display recent jobs
        function displayRecentJobs(jobs) {
            const container = document.getElementById('recent-jobs');
            
            if (jobs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500">No jobs found for this brand</div>';
                return;
            }
            
            const jobsHtml = jobs.map(job => `
                <div class="py-3 border-b border-gray-200 last:border-b-0 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${escapeHtml(job.title || 'Untitled Job')}</div>
                            <div class="text-sm text-gray-600">Status: <span class="font-medium ${
                                job.status === 'completed' ? 'text-green-600' : 
                                job.status === 'pending' ? 'text-blue-600' : 
                                'text-gray-600'
                            }">${job.status || 'unknown'}</span></div>
                            <div class="text-sm text-gray-500">Created: ${new Date(job.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = jobsHtml;
        }

        // Show error state
        function showError(message) {
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            const errorMsg = document.querySelector('#error-state h2');
            if (errorMsg) {
                errorMsg.textContent = message;
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle sign out
        async function handleSignOut() {
            try {
                await supabase.auth.signOut();
                window.location.href = '../auth/signin.html';
            } catch (error) {
                console.error('Error signing out:', error);
                window.location.href = '../auth/signin.html';
            }
        }
    </script>
</body>
</html>

