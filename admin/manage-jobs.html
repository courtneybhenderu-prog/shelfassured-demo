<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Jobs - Admin Dashboard</title>
    <script>
        // CRITICAL: Disable global guard BEFORE any other scripts load
        window.SA_DISABLE_GLOBAL_GUARD = true;
        window.SA_PAGE_ROLE = 'admin';
        console.log('üîí Global guard disabled for Manage Jobs page');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.5/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="../shared/styles.css">
</head>
<body>
    <div class="min-h-screen bg-gray-100">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">Manage Jobs</h1>
                        <span class="ml-3 px-2 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">ADMIN ONLY</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="create-job-btn" onclick="showCreateJobForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Create New Job</button>
                        <a href="dashboard.html" class="text-gray-600 hover:text-gray-900">‚Üê Back to Dashboard</a>
                        <button onclick="signOut()" class="text-gray-600 hover:text-gray-900">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Jobs List Section (Default View) -->
            <div id="jobs-list-section">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">All Jobs</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Total Jobs</div>
                            <div id="total-jobs-count" class="text-2xl font-bold text-gray-900">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Pending</div>
                            <div id="pending-jobs-count" class="text-2xl font-bold text-yellow-600">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Completed</div>
                            <div id="completed-jobs-count" class="text-2xl font-bold text-green-600">0</div>
                        </div>
                    </div>
                </div>
                
                <div id="jobs-table-container" class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="text-lg font-medium text-gray-900">Job List</h3>
                        <div id="bulk-delete-controls" class="hidden flex items-center gap-3">
                            <button id="select-all-pending" class="px-3 py-1 text-sm text-blue-600 hover:text-blue-800 border border-blue-300 rounded hover:bg-blue-50">
                                Select All Pending
                            </button>
                            <button id="delete-selected-jobs" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Delete Selected (<span id="selected-count">0</span>)
                            </button>
                        </div>
                    </div>
                    <div id="jobs-table-body" class="divide-y divide-gray-200">
                        <!-- Jobs will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Create Job Form Section (Hidden by Default) -->
            <div id="create-job-section" class="hidden">
            <!-- Job Creation Form -->
            <div class="bg-white rounded-lg shadow-sm border p-8">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Create New Job</h2>
                    <p class="text-gray-600">Create shelf audit jobs for shelfers to complete</p>
                </div>

                <!-- Error Messages -->
                <div id="error-messages" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error creating job</h3>
                            <div id="error-details" class="mt-2 text-sm text-red-700"></div>
                            <div class="mt-4 flex space-x-3">
                                <button id="retry-button" class="text-sm bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200">Try Again</button>
                                <button id="cancel-button" class="text-sm bg-gray-100 text-gray-800 px-3 py-1 rounded hover:bg-gray-200">Cancel and Exit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success Messages -->
                <div id="success-messages" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Jobs created successfully!</h3>
                            <div id="success-details" class="mt-2 text-sm text-green-700"></div>
                        </div>
                    </div>
                </div>

                <form id="job-creation-form" class="space-y-6">
                    <!-- Job Title -->
                    <div>
                        <label for="job-title" class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                        <input type="text" id="job-title" name="job-title" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., DJ's Boudain Shelf Audit">
                        <p class="mt-1 text-sm text-gray-500">5-255 characters</p>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="job-description" class="block text-sm font-medium text-gray-700 mb-2">Job Description</label>
                        <textarea id="job-description" name="job-description" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Optional description of the job requirements"></textarea>
                        <p class="mt-1 text-sm text-gray-500">Maximum 2000 characters</p>
                    </div>

                    <!-- Brand Selection -->
                    <div>
                        <label for="brand-name" class="block text-sm font-medium text-gray-700 mb-2">Brand *</label>
                        <div class="relative">
                            <input type="text" id="brand-name" name="brand-name" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="e.g., DJ's Boudain, Callie's Hot Little Biscuits">
                            <div id="brand-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg hidden"></div>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Type brand name - will create new brand if not found</p>
                    </div>

                    <!-- Enhanced Store Selection -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">Store Selection *</label>
                            <div class="flex space-x-2">
                                <button type="button" onclick="console.log('Select All Filtered clicked'); if(window.storeSelector) { window.storeSelector.selectAllFiltered(); } else { console.error('storeSelector not found'); }" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Select All Filtered
                                </button>
                                <button type="button" onclick="console.log('Clear All clicked'); if(window.storeSelector) { window.storeSelector.clearAll(); } else { console.error('storeSelector not found'); }" 
                                        class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                    Clear All
                                </button>
                            </div>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Search Input -->
                            <div>
                                <label for="store-search" class="block text-sm font-medium text-gray-700 mb-1">Search Stores</label>
                                <input type="text" id="store-search" placeholder="Search by name, city, address, or ZIP..."
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <!-- Chain Filter -->
                            <div>
                                <label for="chain-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Chain</label>
                                <select id="chain-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="all">All Chains</option>
                                    <!-- Banner options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <!-- Location Services -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-blue-900">üìç Location Services</div>
                                    <div class="text-sm text-blue-700">Get nearby store suggestions based on your location</div>
                                </div>
                                <button type="button" onclick="storeSelector.getCurrentLocation()" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Enable Location
                                </button>
                            </div>
                        </div>

                        <!-- Selected Stores Display -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2">
                                Selected Stores (<span id="selected-count">0</span>)
                            </div>
                            <div id="selected-stores" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-center text-gray-500 py-4">No stores selected</div>
                            </div>
                        </div>

                        <!-- Store Search Results -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2">
                                Available Stores (<span id="filtered-count">0</span>)
                            </div>
                            <div id="store-search-results" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-center text-gray-500 py-4">Loading stores...</div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-700 mb-2">Quick Actions</div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <button type="button" onclick="storeSelector.filterByChain('heb')" 
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                    H-E-B Only
                                </button>
                                <button type="button" onclick="storeSelector.filterByChain('whole foods market')" 
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                    Whole Foods Market
                                </button>
                                <button type="button" onclick="storeSelector.filterByChain('tom thumb')" 
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                    Tom Thumb
                                </button>
                                <button type="button" onclick="storeSelector.filterByChain('all')" 
                                        class="px-3 py-2 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                    All Chains
                                </button>
                            </div>
                        </div>

                        <!-- Help Text -->
                        <div class="text-sm text-gray-500">
                            <p>üí° <strong>Tips:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>Search by store name, city, address, or ZIP code</li>
                                <li>Use location services to find stores near you</li>
                                <li>Filter by chain to focus on specific retailers</li>
                                <li>Click on stores to select them for the job</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Product Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Products to Check *</label>
                        <div id="sku-selection" class="space-y-2">
                            <div class="space-y-2">
                                <div class="relative">
                                    <input type="text" id="product-name" placeholder="Product name (e.g., Original Boudain)" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <div id="product-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg hidden mt-1 max-h-60 overflow-y-auto"></div>
                                </div>
                                <input type="text" id="product-sku" placeholder="UPC (optional, e.g., 0123456789012)" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <select id="product-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <!-- Categories will be populated by JavaScript -->
                                </select>
                                <button type="button" onclick="addSkuInput()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Product</button>
                                <div id="available-products" class="mt-3 p-2 bg-gray-50 rounded hidden"></div>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Add products to audit - UPC can be added later in store if not known</p>
                    </div>

                    <!-- Assigned User -->
                    <div>
                        <label for="assigned-user" class="block text-sm font-medium text-gray-700 mb-2">Assigned To *</label>
                        <select id="assigned-user" name="assigned-user" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select user...</option>
                        </select>
                    </div>

                    <!-- Priority -->
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select id="priority" name="priority"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="normal">Normal</option>
                            <option value="low">Low</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>

                    <!-- Due Date -->
                    <div>
                        <label for="due-date" class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="datetime-local" id="due-date" name="due-date"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="mt-1 text-sm text-gray-500">Standard timeline: 48 hours (placeholder for Marc's feedback)</p>
                    </div>

                    <!-- Additional Notes -->
                    <div>
                        <label for="special-instructions" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                        <textarea id="special-instructions" name="special-instructions" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder=""></textarea>
                        <p class="mt-1 text-sm text-gray-500">Standard requirements: 3 photos (product on shelf, price tag, overall shelf view) + price verification + stock level check. Beyond this requires custom audit.</p>
                    </div>

                    <!-- Job Summary -->
                    <div id="job-summary" class="hidden bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Job Summary</h3>
                        <div id="summary-details" class="text-sm text-gray-600"></div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-between pt-6 border-t border-gray-200">
                        <button type="button" onclick="goToPage('dashboard.html')" 
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" id="confirm-job-btn"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="submit-text">Confirm Job</span>
                            <span id="loading-spinner" class="hidden ml-2">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../shared/api.js?v=20250113-4"></script>
    <script src="../shared/categories.js"></script>
    <script src="enhanced-store-selector.js?v=20250113-13"></script>
    <script>
        // Global variables
        let brands = [];
        let stores = [];
        let skus = [];
        let users = [];
        let selectedStores = [];
        let selectedSkus = [];

        // Populate category dropdown
        function populateCategoryDropdown() {
            const categorySelect = document.getElementById('product-category');
            if (categorySelect && typeof generateCategoryDropdownHTML === 'function') {
                categorySelect.innerHTML = generateCategoryDropdownHTML(true);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üîÑ Starting job management form initialization...');
                
                // Check if supabase is available
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase not available');
                }
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('‚ùå No user found, redirecting to signin');
                    window.location.href = '../auth/signin.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', user.email);
                
                // Check if we're in edit mode or have brand_id preset
                const urlParams = new URLSearchParams(window.location.search);
                const editJobId = urlParams.get('edit_job_id');
                const presetBrandId = urlParams.get('brand_id');
                
                console.log('üîç URL params:', window.location.search);
                console.log('üîç editJobId:', editJobId);
                console.log('üîç presetBrandId:', presetBrandId);
                
                if (editJobId) {
                    console.log('üîÑ Edit mode detected for job:', editJobId);
                    await loadJobForEdit(editJobId);
                } else {
                    console.log('üîÑ Create mode - loading initial data...');
                    await loadInitialData();
                    
                    // Preselect brand if brand_id is provided in URL
                    if (presetBrandId) {
                        console.log('üîÑ Preselecting brand from URL:', presetBrandId);
                        await preselectBrand(presetBrandId);
                    }
                }
                
                // Setup form event listeners
                console.log('üîÑ Setting up form event listeners...');
                setupFormEventListeners();
                
                // Setup error handling
                console.log('üîÑ Setting up error handling...');
                setupErrorHandling();
                
                // Populate category dropdown
                populateCategoryDropdown();
                
                // Load jobs list by default (unless in edit mode)
                if (!editJobId) {
                    await loadJobsList();
                }
                
                console.log('‚úÖ Job management form initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing job creation form:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                showError('Failed to load job creation form. Please refresh the page.');
            }
        });

        // Load job for edit mode
        async function loadJobForEdit(jobId) {
            try {
                console.log('üîÑ Loading job for edit:', jobId);
                
                // Load job with all related data
                const { data: job, error } = await supabase
                    .from('jobs')
                    .select(`
                        *,
                        brands(name),
                        job_stores(stores(id, name, city, state)),
                        job_skus(skus(id, name, upc, category)),
                        job_store_skus(
                            stores(id, name, city, state),
                            skus(id, name, upc, category)
                        ),
                        assigned_user:assigned_user_id(full_name)
                    `)
                    .eq('id', jobId)
                    .single();

                if (error) {
                    console.error('‚ùå Error loading job:', error);
                    throw new Error(`Job not found or error loading: ${error.message}`);
                }
                
                if (!job) {
                    throw new Error('Job not found');
                }
                
                console.log('‚úÖ Job loaded for edit:', job);
                
                // Populate form fields
                const titleEl = document.getElementById('job-title');
                const descEl = document.getElementById('job-description');
                const brandEl = document.getElementById('brand-name');
                if (titleEl) titleEl.value = job.title || '';
                if (descEl) descEl.value = job.description || '';
                if (brandEl) brandEl.value = job.brands?.name || '';
                
                // Set priority
                if (job.priority) {
                    const prEl = document.getElementById('priority');
                    if (prEl) prEl.value = job.priority;
                }
                
                // Set due date
                if (job.due_date) {
                    const dueDate = new Date(job.due_date).toISOString().split('T')[0];
                    const dueEl = document.getElementById('due-date');
                    if (dueEl) dueEl.value = dueDate;
                }
                
                // Set assigned user
                if (job.assigned_user_id) {
                    const auEl = document.getElementById('assigned-user');
                    if (auEl) auEl.value = job.assigned_user_id;
                }
                
                // Set additional notes
                if (job.instructions) {
                    const notesEl = document.getElementById('special-instructions');
                    if (notesEl) notesEl.value = job.instructions;
                }
                
                // Populate stores (prefer job_store_skus if present; fallback to job_stores)
                const storesFromJSKS = (job.job_store_skus || []).map(r => r.stores).filter(Boolean);
                const storesFromJS = (job.job_stores || []).map(r => r.stores).filter(Boolean);
                const uniqueStoresMap = new Map();
                [...storesFromJSKS, ...storesFromJS].forEach(s => { if (s?.id) uniqueStoresMap.set(s.id, s); });
                selectedStores = Array.from(uniqueStoresMap.values());
                updateSelectedStoresDisplay();
                if (window.storeSelector && typeof window.storeSelector.setSelectedStores === 'function') {
                    try { 
                        window.storeSelector.setSelectedStores(selectedStores);
                        // Load stores so they appear in available stores list
                        setTimeout(() => {
                            if (window.storeSelector && typeof window.storeSelector.loadStoresFromDatabase === 'function') {
                                window.storeSelector.loadStoresFromDatabase();
                            }
                        }, 500);
                    } catch (_) {}
                }

                // Populate SKUs (prefer job_store_skus if present; fallback to job_skus)
                const skusFromJSKS = (job.job_store_skus || []).map(r => r.skus).filter(Boolean);
                const skusFromJK = (job.job_skus || []).map(r => r.skus).filter(Boolean);
                const uniqueSkuMap = new Map();
                [...skusFromJSKS, ...skusFromJK].forEach(k => { if (k?.id) uniqueSkuMap.set(k.id, k); });
                selectedSkus = Array.from(uniqueSkuMap.values()).map(k => ({ 
                    name: k.name, 
                    sku: k.upc || null,
                    category: k.category || null
                }));
                updateSkuDisplay();
                
                // Change form title and button
                document.querySelector('h2').textContent = 'Edit Job';
                const confirmBtn = document.getElementById('confirm-job-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = 'Save Changes';
                    confirmBtn.onclick = () => updateJob(jobId);
                }
                
                // Add delete button
                addDeleteButton(jobId);
                
                // Show form and hide job list
                document.getElementById('create-job-section').classList.remove('hidden');
                document.getElementById('jobs-list-section').classList.add('hidden');
                document.getElementById('create-job-btn').textContent = 'Back to Jobs List';
                document.getElementById('create-job-btn').onclick = showJobsList;
                
            } catch (error) {
                console.error('‚ùå Error loading job for edit:', error);
                
                // If job doesn't exist, redirect to clean page
                if (error.message.includes('not found') || error.message.includes('Job not found')) {
                    console.log('üîÑ Job not found, redirecting to clean page...');
                    window.location.href = 'manage-jobs.html';
                    return;
                }
                
                showError('Failed to load job for editing. Please try again.');
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                console.log('üîÑ Loading initial data...');
                
                // Load brands, skus, and users (stores are loaded by enhanced store selector)
                const [brandsResult, skusResult, usersResult] = await Promise.all([
                    supabase.from('brands').select('*').order('name'),
                    supabase.from('skus').select('*').order('name'),
                    supabase.from('users').select('*').eq('is_active', true).order('full_name')
                ]);

                brands = brandsResult.data || [];
                skus = skusResult.data || [];
                users = usersResult.data || [];
                
                // Initialize stores as empty array (will be populated by enhanced store selector)
                stores = [];

                // Populate assigned user dropdown
                populateUserDropdown();
                
                console.log('üìä Loaded data:', {
                    brands: brands.length,
                    stores: 'loaded by enhanced store selector',
                    skus: skus.length,
                    users: users.length
                });
                
            } catch (error) {
                console.error('‚ùå Error loading initial data:', error);
                // Don't throw error, just log it and continue
                brands = [];
                skus = [];
                users = [];
                stores = [];
            }
        }

        // Preselect brand from brand_id parameter
        async function preselectBrand(brandId) {
            try {
                // Find brand in loaded brands array
                const brand = brands.find(b => b.id === brandId);
                
                if (!brand) {
                    console.warn('‚ö†Ô∏è Brand not found in loaded brands, fetching...');
                    // Try to fetch it directly
                    const { data, error } = await supabase
                        .from('brands')
                        .select('id, name')
                        .eq('id', brandId)
                        .single();
                    
                    if (error || !data) {
                        console.error('‚ùå Error fetching brand:', error);
                        return;
                    }
                    
                    // Add to brands array for future use
                    brands.push(data);
                    
                    // Set brand input
                    const brandInput = document.getElementById('brand-name');
                    if (brandInput) {
                        brandInput.value = data.name;
                        currentBrandId = data.id;
                        console.log('Job form brand context:', data.id, data.name);
                    }
                    
                    // Load brand products
                    if (currentBrandId) {
                        loadBrandProducts(currentBrandId);
                    }
                    
                    return;
                }
                
                // Brand found in loaded array
                const brandInput = document.getElementById('brand-name');
                if (brandInput) {
                    brandInput.value = brand.name;
                    currentBrandId = brand.id;
                    console.log('Job form brand context:', brand.id, brand.name);
                }
                
                // Load brand products
                if (currentBrandId) {
                    loadBrandProducts(currentBrandId);
                }
                
            } catch (error) {
                console.error('‚ùå Error preselecting brand:', error);
            }
        }

        // Populate user dropdown (filtered to Courtney and Marc only)
        function populateUserDropdown() {
            const select = document.getElementById('assigned-user');
            select.innerHTML = '<option value="">Select user...</option>';
            
            // Filter to only show Courtney and Marc
            const filteredUsers = users.filter(user => {
                const name = (user.full_name || '').toLowerCase();
                return name.includes('courtney') || name.includes('marc');
            });
            
            filteredUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.full_name || 'No name'} (${user.role})`;
                select.appendChild(option);
            });
        }

        // Setup form event listeners
        function setupFormEventListeners() {
            try {
                console.log('üîÑ Setting up brand autocomplete...');
                // Brand autocomplete
                const brandInput = document.getElementById('brand-name');
                console.log('Brand input element:', brandInput);
                if (brandInput) {
                    brandInput.addEventListener('input', handleBrandInput);
                    // Use mousedown to prevent blur event from interfering with clicks
                    brandInput.addEventListener('blur', function(e) {
                        // Small delay to allow click events on suggestions to fire first
                        setTimeout(() => {
                            hideBrandSuggestions();
                        }, 200);
                    });
                    console.log('‚úÖ Brand autocomplete setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Brand input element not found');
                }

                console.log('üîÑ Setting up product autocomplete...');
                // Product autocomplete
                const productInput = document.getElementById('product-name');
                console.log('Product input element:', productInput);
                if (productInput) {
                    productInput.addEventListener('input', handleProductInput);
                    productInput.addEventListener('blur', function(e) {
                        setTimeout(() => {
                            hideProductSuggestions();
                        }, 200);
                    });
                    console.log('‚úÖ Product autocomplete setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Product input element not found');
                }
                
                console.log('üîÑ Setting up form submission...');
                // Form submission
                const form = document.getElementById('job-creation-form');
                console.log('Form element:', form);
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                    console.log('‚úÖ Form submission setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Form element not found');
                }
                
                console.log('üîÑ Setting up real-time validation...');
                // Real-time validation
                const jobTitle = document.getElementById('job-title');
                console.log('Job title element:', jobTitle);
                if (jobTitle) {
                    jobTitle.addEventListener('input', updateJobSummary);
                    console.log('‚úÖ Real-time validation setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Job title element not found');
                }
                
                console.log('‚úÖ Form event listeners setup complete');
            } catch (error) {
                console.error('‚ùå Error setting up form event listeners:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                throw error;
            }
        }

        // Setup error handling
        function setupErrorHandling() {
            try {
                console.log('üîÑ Setting up error handling...');
                const retryButton = document.getElementById('retry-button');
                if (retryButton) {
                    retryButton.addEventListener('click', () => {
                        hideError();
                        // Form data is preserved, user can try again
                    });
                }
                
                const cancelButton = document.getElementById('cancel-button');
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        window.location.href = 'dashboard.html';
                    });
                }
                
                console.log('‚úÖ Error handling setup complete');
            } catch (error) {
                console.error('‚ùå Error setting up error handling:', error);
                // Don't throw error for error handling setup
            }
        }

        // Brand input handling
        function handleBrandInput(event) {
            const query = event.target.value.toLowerCase().trim();
            if (query.length < 2) {
                hideBrandSuggestions();
                return;
            }
            
            const matches = brands.filter(brand => 
                brand.name.toLowerCase().includes(query)
            );
            
            showBrandSuggestions(matches);
        }

        // Show brand suggestions
        function showBrandSuggestions(matches) {
            const container = document.getElementById('brand-suggestions');
            container.innerHTML = '';
            
            if (matches.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500">No matching brands found</div>';
            } else {
                matches.forEach(brand => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-200 last:border-b-0';
                    div.textContent = brand.name;
                    // Use mousedown instead of click to prevent blur event issues
                    div.addEventListener('mousedown', (e) => {
                        e.preventDefault(); // Prevent blur event on input
                        document.getElementById('brand-name').value = brand.name;
                        hideBrandSuggestions();
                        // Set current brand ID for store checking
                        currentBrandId = brand.id;
                        // Auto-populate products from brand_products
                        loadBrandProducts(brand.id);
                        updateJobSummary();
                    });
                    container.appendChild(div);
                });
            }
            
            container.classList.remove('hidden');
        }

        // Hide brand suggestions
        function hideBrandSuggestions() {
            document.getElementById('brand-suggestions').classList.add('hidden');
        }

        // Product input handling
        let productsCache = [];
        let productsCachePromise = null;

        async function loadProducts() {
            if (productsCache.length > 0) return productsCache;
            if (productsCachePromise) return productsCachePromise;
            
            productsCachePromise = (async () => {
                try {
                    const { data, error } = await supabase
                        .from('products')
                        .select('id, name, sku, upc, category')
                        .order('name');
                    
                    if (error) throw error;
                    
                    productsCache = data || [];
                    return productsCache;
                } catch (error) {
                    console.error('Error loading products:', error);
                    return [];
                } finally {
                    productsCachePromise = null;
                }
            })();
            
            return productsCachePromise;
        }

        async function handleProductInput(event) {
            const query = event.target.value.toLowerCase().trim();
            console.log('üîç Product input:', query);
            if (query.length < 2) {
                hideProductSuggestions();
                return;
            }

            console.log('üì¶ Loading products...');
            const allProducts = await loadProducts();
            console.log('‚úÖ Products loaded:', allProducts.length);
            
            // If a brand is selected, filter products linked to that brand via brand_products
            let matches = [];
            if (currentBrandId) {
                console.log('üè∑Ô∏è Filtering by brand:', currentBrandId);
                try {
                    // Get product IDs linked to the selected brand
                    const { data: brandProducts, error } = await supabase
                        .from('brand_products')
                        .select('product_id')
                        .eq('brand_id', currentBrandId);
                    
                    if (error) {
                        console.error('Error fetching brand products:', error);
                    } else {
                        console.log('üìã Brand products found:', brandProducts?.length || 0);
                    }
                    
                    if (!error && brandProducts && brandProducts.length > 0) {
                        const linkedProductIds = brandProducts.map(bp => bp.product_id);
                        matches = allProducts
                            .filter(p => linkedProductIds.includes(p.id))
                            .filter(p => p.name && p.name.toLowerCase().includes(query))
                            .slice(0, 20); // Limit to 20 results
                        console.log('‚úÖ Matches from brand:', matches.length);
                    }
                } catch (error) {
                    console.error('Error filtering products by brand:', error);
                }
            }
            
            // If no brand selected or no matches from brand, search all products
            if (matches.length === 0) {
                console.log('üîç Searching all products...');
                matches = allProducts
                    .filter(p => p.name && p.name.toLowerCase().includes(query))
                    .slice(0, 20);
                console.log('‚úÖ All product matches:', matches.length);
            }
            
            console.log('üéØ Final matches:', matches.length);
            showProductSuggestions(matches);
        }

        // Show product suggestions
        function showProductSuggestions(matches) {
            console.log('üé® Showing product suggestions:', matches.length);
            const container = document.getElementById('product-suggestions');
            
            if (!container) {
                console.error('‚ùå Product suggestions container not found!');
                return;
            }
            
            container.innerHTML = '';
            
            if (matches.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500">No matching products found</div>';
            } else {
                console.log('üìù Adding', matches.length, 'product suggestions to dropdown');
                matches.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-200 last:border-b-0';
                    div.innerHTML = `
                        <div class="font-medium">${escapeHtml(product.name || 'Unnamed Product')}</div>
                        <div class="text-xs text-gray-500">
                            ${(product.sku || product.upc) ? `UPC: ${escapeHtml(product.sku || product.upc)}` : ''}
                            ${product.category ? ` ‚Ä¢ ${escapeHtml(product.category)}` : ''}
                        </div>
                    `;
                    div.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        document.getElementById('product-name').value = product.name;
                        if (product.sku || product.upc) {
                            document.getElementById('product-sku').value = product.sku || product.upc;
                        }
                        // Set category dropdown to match product's category
                        if (product.category) {
                            const categorySelect = document.getElementById('product-category');
                            if (categorySelect) {
                                const categoryValue = product.category.trim();
                                // Try exact match first
                                categorySelect.value = categoryValue;
                                
                                // If no match found, try case-insensitive match
                                if (!categorySelect.value || categorySelect.value === '') {
                                    const options = Array.from(categorySelect.options);
                                    const matchingOption = options.find(opt => 
                                        opt.value.toLowerCase() === categoryValue.toLowerCase()
                                    );
                                    if (matchingOption) {
                                        categorySelect.value = matchingOption.value;
                                        console.log(`‚úÖ Category matched (case-insensitive): ${categoryValue} ‚Üí ${matchingOption.value}`);
                                    } else {
                                        console.warn(`‚ö†Ô∏è Category "${categoryValue}" not found in dropdown options`);
                                    }
                                } else {
                                    console.log(`‚úÖ Category set: ${categoryValue}`);
                                }
                            }
                        } else {
                            // Clear category if product has no category
                            const categorySelect = document.getElementById('product-category');
                            if (categorySelect) {
                                categorySelect.value = '';
                            }
                        }
                        hideProductSuggestions();
                    });
                    container.appendChild(div);
                });
            }
            
            container.classList.remove('hidden');
            console.log('‚úÖ Dropdown should now be visible');
        }

        // Hide product suggestions
        function hideProductSuggestions() {
            const container = document.getElementById('product-suggestions');
            if (container) {
                container.classList.add('hidden');
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle all stores checkbox
        function handleAllStoresChange(event) {
            const storeSelection = document.getElementById('store-selection');
            if (event.target.checked) {
                storeSelection.style.display = 'none';
                selectedStores = stores.map(store => store.name);
            } else {
                storeSelection.style.display = 'block';
                // Don't clear manually added stores when unchecking "All active stores"
                // selectedStores = []; // REMOVED - this was clearing user's manual entries
            }
            updateJobSummary();
        }

        // Add store input
        function addStoreInput() {
            const container = document.getElementById('store-selection');
            const input = container.querySelector('input');
            const storeName = input.value.trim();
            
            if (!storeName) {
                alert('Please enter a store name');
                return;
            }
            
            if (selectedStores.includes(storeName)) {
                alert('Store already added');
                return;
            }
            
            selectedStores.push(storeName);
            input.value = '';
            updateJobSummary();
            updateStoreDisplay();
        }

        // Load products from brand_products when brand is selected
        async function loadBrandProducts(brandId) {
            try {
                console.log('üì¶ Loading products for brand:', brandId);
                
                // Fetch products linked to this brand via brand_products
                const { data: brandProducts, error } = await supabase
                    .from('brand_products')
                    .select(`
                        product_id,
                        product_label,
                        products (
                            id,
                            name,
                            sku,
                            upc,
                            category
                        )
                    `)
                    .eq('brand_id', brandId);
                
                if (error) {
                    console.error('Error fetching brand products:', error);
                    return;
                }
                
                // Render available products list with "+ Add" buttons; do NOT auto-add
                const avail = document.getElementById('available-products');
                if (!avail) return;
                
                if (!brandProducts || brandProducts.length === 0) {
                    avail.classList.remove('hidden');
                    avail.innerHTML = '<div class="text-sm text-gray-500">No available products for this brand yet</div>';
                    return;
                }
                
                const items = brandProducts
                    .map(bp => ({
                        id: bp.products?.id || bp.product_id,
                        name: bp.product_label || bp.products?.name || 'Unknown',
                        sku: bp.products?.sku || bp.products?.upc || '',
                        category: bp.products?.category || ''
                    }))
                    .filter(p => p.name && p.name !== 'Unknown');
                
                avail.classList.remove('hidden');
                avail.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mb-1">Available Products:</div>
                    <div class="flex flex-wrap gap-2">
                        ${items.map(p => `
                            <span class=\"px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full flex items-center gap-1\">
                                <span>${p.name}${p.sku ? ` (${p.sku})` : ''}${p.category ? ` [${p.category}]` : ''}</span>
                                <button type=\"button\" class=\"text-blue-600 hover:text-blue-800\" onclick=\"addAvailableProduct('${encodeURIComponent(p.name)}','${encodeURIComponent(p.sku || '')}','${encodeURIComponent(p.category || '')}')\">+ Add</button>
                            </span>
                        `).join('')}
                    </div>
                `;
                console.log('‚úÖ Available products rendered:', items.length);
            } catch (error) {
                console.error('Error loading brand products:', error);
            }
        }

        // Add from available list into Selected Products
        function addAvailableProduct(encodedName, encodedSku, encodedCategory) {
            const name = decodeURIComponent(encodedName);
            const sku = decodeURIComponent(encodedSku || '');
            const category = encodedCategory ? decodeURIComponent(encodedCategory) : null;
            const exists = selectedSkus.find(s => s.name === name);
            if (exists) return;
            selectedSkus.push({ name, sku: sku || null, category: category || null });
            updateSkuDisplay();
            updateJobSummary();
        }
        
        // Check if store is in brand_stores (non-blocking warning)
        let currentBrandId = null;
        const storesToAddToBrand = new Set(); // Track stores user wants to add to brand
        
        async function checkStoreInBrand(storeId) {
            if (!currentBrandId || !storeId) return;
            
            try {
                const { data: exists } = await supabase
                    .from('brand_stores')
                    .select('id', { count: 'exact', head: true })
                    .eq('brand_id', currentBrandId)
                    .eq('store_id', storeId)
                    .maybeSingle();
                
                return exists !== null;
            } catch (error) {
                console.warn('Error checking brand_stores:', error);
                return false;
            }
        }
        
        // Show warning if store not in brand_stores (called by store selector)
        async function handleStoreSelection(storeId, storeName) {
            if (!currentBrandId) return;
            
            const isKnown = await checkStoreInBrand(storeId);
            if (!isKnown) {
                // Show non-blocking warning
                const warningMsg = `‚ö†Ô∏è This store (${storeName}) isn't listed for this brand yet. You can proceed; we'll learn from this job.`;
                const warningDiv = document.createElement('div');
                warningDiv.className = 'mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800';
                warningDiv.innerHTML = `
                    ${warningMsg}
                    <label class="mt-2 flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" class="form-checkbox" onchange="toggleAddStoreToBrand('${storeId}', this.checked)">
                        <span>Add this store to brand's known locations after job is created</span>
                    </label>
                `;
                
                // Append to selected stores area or form
                const selectedStoresContainer = document.getElementById('selected-stores');
                if (selectedStoresContainer) {
                    const existingWarning = selectedStoresContainer.querySelector('.store-warning');
                    if (existingWarning) existingWarning.remove();
                    warningDiv.classList.add('store-warning');
                    selectedStoresContainer.appendChild(warningDiv);
                }
            }
        }
        
        // Toggle adding store to brand_stores after job creation (globally accessible)
        window.toggleAddStoreToBrand = function(storeId, shouldAdd) {
            if (shouldAdd) {
                storesToAddToBrand.add(storeId);
            } else {
                storesToAddToBrand.delete(storeId);
            }
        };
        
        // Add selected stores to brand_stores after job creation (if checkbox was checked)
        async function addStoresToBrandAfterJob(brandId, storeIds) {
            if (!brandId || !storeIds || storeIds.length === 0) return;
            
            // Filter to only stores that user checked the box for
            const storesToAdd = storeIds.filter(id => storesToAddToBrand.has(id));
            if (storesToAdd.length === 0) return;
            
            const brandStoreLinks = storesToAdd.map(storeId => ({
                brand_id: brandId,
                store_id: storeId,
                source: 'job'
            }));
            
            try {
                const { error } = await supabase
                    .from('brand_stores')
                    .upsert(brandStoreLinks, {
                        onConflict: 'brand_id,store_id',
                        ignoreDuplicates: false
                    });
                
                if (error) {
                    console.warn('Could not add stores to brand_stores:', error);
                } else {
                    console.log(`Added ${storesToAdd.length} stores to brand_stores`);
                }
            } catch (error) {
                console.error('Error adding stores to brand:', error);
            }
        }

        // Add SKU input
        function addSkuInput() {
            const productName = document.getElementById('product-name').value.trim();
            const productSku = document.getElementById('product-sku').value.trim();
            const productCategory = document.getElementById('product-category').value.trim();
            
            if (!productName) {
                alert('Please enter a product name');
                return;
            }
            
            // Check if product name already exists
            const existingProduct = selectedSkus.find(sku => sku.name === productName);
            if (existingProduct) {
                alert('Product already added');
                return;
            }
            
            // Add product with name, SKU (UPC), and category
            const productData = {
                name: productName,
                sku: productSku || null,
                category: productCategory || null
            };
            
            selectedSkus.push(productData);
            
            // Clear inputs
            document.getElementById('product-name').value = '';
            document.getElementById('product-sku').value = '';
            document.getElementById('product-category').value = '';
            
            updateJobSummary();
            updateSkuDisplay();
        }

        // Update store display
        function updateStoreDisplay() {
            const container = document.getElementById('store-selection');
            const existingDisplay = container.querySelector('.selected-stores');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            if (selectedStores.length > 0) {
                const display = document.createElement('div');
                display.className = 'selected-stores mt-2 p-2 bg-gray-50 rounded';
                display.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mb-1">Selected Stores:</div>
                    <div class="flex flex-wrap gap-2">
                        ${selectedStores.map(store => `
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                ${store}
                                <button type="button" onclick="removeStore('${store}')" class="ml-1 text-blue-600 hover:text-blue-800">√ó</button>
                            </span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(display);
            }
        }

        // Update SKU display
        function updateSkuDisplay() {
            const container = document.getElementById('sku-selection');
            const existingDisplay = container.querySelector('.selected-skus');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            if (selectedSkus.length > 0) {
                const display = document.createElement('div');
                display.className = 'selected-skus mt-2 p-2 bg-gray-50 rounded';
                display.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mb-1">Selected Products:</div>
                    <div class="flex flex-wrap gap-2">
                        ${selectedSkus.map((sku, index) => `
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                ${sku.name}${sku.sku ? ` (UPC: ${sku.sku})` : ''}${sku.category ? ` [${sku.category}]` : ''}
                                <button type="button" onclick="removeSku(${index})" class="ml-1 text-green-600 hover:text-green-800">√ó</button>
                            </span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(display);
            }
        }

        // Remove store
        function removeStore(storeName) {
            selectedStores = selectedStores.filter(s => s !== storeName);
            updateJobSummary();
            updateStoreDisplay();
        }

        // Remove SKU
        function removeSku(index) {
            selectedSkus.splice(index, 1);
            updateJobSummary();
            updateSkuDisplay();
        }

        // Update job summary
        function updateJobSummary() {
            const title = document.getElementById('job-title').value.trim();
            const brand = document.getElementById('brand-name').value.trim();
            
            // Get selected stores from enhanced store selector
            const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
            const skus = selectedSkus;
            
            if (title && brand && selectedStores.length > 0 && skus.length > 0) {
                const totalJobs = selectedStores.length * skus.length;
                const summary = document.getElementById('summary-details');
                summary.innerHTML = `
                    <div class="space-y-1">
                        <div><strong>Title:</strong> ${title}</div>
                        <div><strong>Brand:</strong> ${brand}</div>
                        <div><strong>Stores:</strong> ${selectedStores.length}</div>
                        <div><strong>Products:</strong> ${skus.length}</div>
                        <div class="font-medium text-blue-600"><strong>Total Jobs:</strong> ${totalJobs}</div>
                    </div>
                `;
                document.getElementById('job-summary').classList.remove('hidden');
            } else {
                document.getElementById('job-summary').classList.add('hidden');
            }
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            try {
                // Validate form
                if (!validateForm()) {
                    return;
                }
                // Confirmation if creating multiple jobs (one per store)
                const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
                if (selectedStores.length > 1) {
                    const skusCount = selectedSkus.length;
                    const totalJobs = selectedStores.length; // one per store
                    const confirmed = confirm(`This will create ${totalJobs} job(s) with ${skusCount} product(s) each. Continue?`);
                    if (!confirmed) return;
                }
                
                // Show loading state
                setLoadingState(true);
                hideError();
                hideSuccess();
                
                // Get form data
                const formData = getFormData();
                
                // Create jobs
                const result = await createJobs(formData);
                
                // Show success
                showSuccess(result);
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error creating jobs:', error);
                showError(error.message);
            } finally {
                setLoadingState(false);
            }
        }

        // Validate form
        function validateForm() {
            const title = document.getElementById('job-title').value.trim();
            const brand = document.getElementById('brand-name').value.trim();
            const assignedUser = document.getElementById('assigned-user').value;
            
            // Get selected stores from enhanced store selector
            const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
            
            if (!title || title.length < 5) {
                alert('Job title must be at least 5 characters');
                return false;
            }
            
            if (!brand) {
                alert('Brand name is required');
                return false;
            }
            
            if (selectedStores.length === 0) {
                alert('Please select at least one store');
                return false;
            }
            
            if (selectedSkus.length === 0) {
                alert('Please add at least one product (SKU)');
                return false;
            }
            
            if (!assignedUser) {
                alert('Please select an assigned user');
                return false;
            }
            
            return true;
        }

        // Get form data
        function getFormData() {
            // Get selected stores from enhanced store selector
            const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
            
            return {
                title: document.getElementById('job-title').value.trim(),
                description: document.getElementById('job-description').value.trim(),
                brand: document.getElementById('brand-name').value.trim(),
                stores: selectedStores, // Use enhanced store selector
                skus: selectedSkus,
                assignedUserId: document.getElementById('assigned-user').value,
                priority: document.getElementById('priority').value,
                dueDate: document.getElementById('due-date').value,
                specialInstructions: document.getElementById('special-instructions').value.trim()
            };
        }

        // Create jobs
        async function createJobs(formData) {
            const errors = [];
            const createdJobs = [];
            
            try {
                console.log('üîÑ Creating jobs with form data:', formData);
                
                // Ensure brand exists
                let brandId = await ensureBrandExists(formData.brand);
                console.log('‚úÖ Brand ID:', brandId);
                
                // Get store IDs from enhanced store selector (no need to create new stores)
                const storeIds = formData.stores.map(store => store.id);
                console.log('‚úÖ Store IDs:', storeIds);
                
                // Ensure SKUs exist
                const skuIds = await ensureSkusExist(formData.skus, brandId);
                console.log('‚úÖ SKU IDs:', skuIds);
                
                // Create ONE job per store with the same product set
                let totalAssignments = 0;
                
                // Convert dueDate to proper format (datetime-local to ISO string)
                let dueDateValue = null;
                if (formData.dueDate) {
                    dueDateValue = new Date(formData.dueDate).toISOString();
                }
                
                for (const storeId of storeIds) {
                    const jobData = {
                        title: formData.title,
                        description: formData.description || null,
                        brand_id: brandId,
                        assigned_user_id: formData.assignedUserId,
                        priority: formData.priority || 'normal',
                        due_date: dueDateValue,
                        instructions: formData.specialInstructions || null,
                        status: 'pending',
                        payout_per_store: 5.00,
                        created_at: new Date().toISOString()
                    };
                    const { data: jobRow, error: jobErr } = await supabase
                        .from('jobs')
                        .insert(jobData)
                        .select()
                        .single();
                    if (jobErr) throw jobErr;
                    
                    const assignments = skuIds.map(skuId => ({
                        job_id: jobRow.id,
                        store_id: storeId,
                        sku_id: skuId
                    }));
                    const { error: assignmentError } = await supabase
                        .from('job_store_skus')
                        .upsert(assignments, { onConflict: 'job_id,store_id,sku_id', ignoreDuplicates: true });
                    if (assignmentError) throw assignmentError;
                    totalAssignments += assignments.length;
                    createdJobs.push(jobRow);
                }
                
                // Add stores to brand_stores if requested (non-blocking)
                await addStoresToBrandAfterJob(brandId, storeIds);
                
                if (errors.length > 0 && createdJobs.length === 0) {
                    throw new Error(`All jobs failed to create: ${errors.join(', ')}`);
                }
                
                return {
                    created: createdJobs.length,
                    assignments: createdJobs.length * skuIds.length,
                    jobId: createdJobs[0]?.id,
                    errors: errors.length
                };
                
            } catch (error) {
                console.error('‚ùå Error in createJobs:', error);
                throw error;
            }
        }

        // Ensure brand exists
        async function ensureBrandExists(brandName) {
            const existingBrand = brands.find(b => b.name.toLowerCase() === brandName.toLowerCase());
            if (existingBrand) {
                currentBrandId = existingBrand.id; // Set for store checking
                return existingBrand.id;
            }
            
            const { data: brand, error } = await supabase
                .from('brands')
                .insert({ name: brandName })
                .select()
                .single();
            
            if (error) throw new Error(`Failed to create brand: ${error.message}`);
            
            brands.push(brand);
            currentBrandId = brand.id; // Set for store checking
            return brand.id;
        }

        // Ensure stores exist
        async function ensureStoresExist(storeNames) {
            const storeIds = [];
            
            for (const storeName of storeNames) {
                const existingStore = stores.find(s => s.name.toLowerCase() === storeName.toLowerCase());
                if (existingStore) {
                    storeIds.push(existingStore.id);
                } else {
                    const { data: store, error } = await supabase
                        .from('stores')
                        .insert({ name: storeName })
                        .select()
                        .single();
                    
                    if (error) throw new Error(`Failed to create store: ${error.message}`);
                    
                    stores.push(store);
                    storeIds.push(store.id);
                }
            }
            
            return storeIds;
        }

        // Ensure SKUs exist
        async function ensureSkusExist(skuData, brandId) {
            const skuIds = [];
            
            for (const skuItem of skuData) {
                // Check if SKU exists by name (case insensitive)
                const existingSku = skus.find(s => s.name.toLowerCase() === skuItem.name.toLowerCase());
                if (existingSku) {
                    skuIds.push(existingSku.id);
                } else {
                    // Create new SKU with name, UPC, and category (UPC and category can be null)
                    const { data: sku, error } = await supabase
                        .from('skus')
                        .insert({ 
                            name: skuItem.name,
                            upc: skuItem.sku || null, // UPC can be null if not provided
                            category: skuItem.category || null, // Category can be null if not provided
                            brand_id: brandId
                        })
                        .select()
                        .single();
                    
                    if (error) throw new Error(`Failed to create SKU: ${error.message}`);
                    
                    skus.push(sku);
                    skuIds.push(sku.id);
                }
            }
            
            return skuIds;
        }

        // Show error
        function showError(message) {
            document.getElementById('error-details').textContent = message;
            document.getElementById('error-messages').classList.remove('hidden');
        }

        // Hide error
        function hideError() {
            document.getElementById('error-messages').classList.add('hidden');
        }

        // Show success
        function showSuccess(result) {
            const details = document.getElementById('success-details');
            details.innerHTML = `
                <div class="space-y-1">
                    <div>‚úÖ Created ${result.created} jobs successfully</div>
                    ${result.errors > 0 ? `<div>‚ö†Ô∏è ${result.errors} jobs failed</div>` : ''}
                    <div>üìä Total expected: ${result.total} jobs</div>
                </div>
            `;
            document.getElementById('success-messages').classList.remove('hidden');
        }

        // Hide success
        function hideSuccess() {
            document.getElementById('success-messages').classList.add('hidden');
        }

        // Show create job form
        function showCreateJobForm() {
            document.getElementById('jobs-list-section').classList.add('hidden');
            document.getElementById('create-job-section').classList.remove('hidden');
            document.getElementById('create-job-btn').textContent = 'Back to Jobs List';
            document.getElementById('create-job-btn').onclick = showJobsList;
        }

        // Show jobs list
        function showJobsList() {
            document.getElementById('create-job-section').classList.add('hidden');
            document.getElementById('jobs-list-section').classList.remove('hidden');
            document.getElementById('create-job-btn').textContent = 'Create New Job';
            document.getElementById('create-job-btn').onclick = showCreateJobForm;
            // Reload jobs list to show updates
            loadJobsList();
        }

        // Load jobs list
        async function loadJobsList() {
            try {
                console.log('üîÑ Loading jobs list...');
                
                // Query jobs with fresh data (no caching)
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select(`
                        *,
                        brands(name),
                        assigned_user:assigned_user_id(full_name),
                        job_stores(stores(name, city, state)),
                        job_skus(skus(name)),
                        job_store_skus(
                            stores(name, city, state),
                            skus(name)
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Ensure jobs is an array
                const jobsArray = Array.isArray(jobs) ? jobs : [];
                console.log(`üìä Jobs loaded: ${jobsArray.length} total jobs`);

                // Update counts - ensure fresh values
                const totalJobs = jobsArray.length;
                const pendingJobs = jobsArray.filter(job => job.status === 'pending').length;
                const completedJobs = jobsArray.filter(job => job.status === 'completed').length;

                console.log(`üìä Updating counts: Total=${totalJobs}, Pending=${pendingJobs}, Completed=${completedJobs}`);

                const totalEl = document.getElementById('total-jobs-count');
                const pendingEl = document.getElementById('pending-jobs-count');
                const completedEl = document.getElementById('completed-jobs-count');
                
                if (totalEl) {
                    totalEl.textContent = totalJobs;
                    console.log(`‚úÖ Updated total jobs count element: ${totalEl.textContent}`);
                }
                if (pendingEl) {
                    pendingEl.textContent = pendingJobs;
                    console.log(`‚úÖ Updated pending jobs count element: ${pendingEl.textContent}`);
                }
                if (completedEl) {
                    completedEl.textContent = completedJobs;
                    console.log(`‚úÖ Updated completed jobs count element: ${completedEl.textContent}`);
                }

                // Render jobs table
                renderJobsTable(jobsArray);

            } catch (error) {
                console.error('‚ùå Error loading jobs:', error);
                document.getElementById('jobs-table-body').innerHTML = '<div class="p-6 text-center text-red-500">Error loading jobs. Please refresh.</div>';
            }
        }

        // Render jobs table
        function renderJobsTable(jobs) {
            const container = document.getElementById('jobs-table-body');
            const bulkControls = document.getElementById('bulk-delete-controls');
            
            if (jobs.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">No jobs found</div>';
                if (bulkControls) bulkControls.classList.add('hidden');
                return;
            }

            // Filter pending jobs
            const pendingJobs = jobs.filter(job => job.status === 'pending');
            
            // Show/hide bulk delete controls based on pending jobs
            if (bulkControls) {
                if (pendingJobs.length > 0) {
                    bulkControls.classList.remove('hidden');
                } else {
                    bulkControls.classList.add('hidden');
                }
            }

            const html = jobs.map(job => {
                const brandName = job.brands?.name || 'Unknown Brand';
                const assignedUser = job.assigned_user?.full_name || 'Unassigned';
                const storesFromJS = (job.job_stores || []).map(js => js.stores?.name).filter(Boolean);
                const skusFromJK = (job.job_skus || []).map(js => js.skus?.name).filter(Boolean);
                const storesFromJSKS = (job.job_store_skus || []).map(r => r.stores?.name).filter(Boolean);
                const skusFromJSKS = (job.job_store_skus || []).map(r => r.skus?.name).filter(Boolean);
                const storeSet = new Set([...(storesFromJS || []), ...(storesFromJSKS || [])]);
                const skuSet = new Set([...(skusFromJK || []), ...(skusFromJSKS || [])]);
                const stores = (storeSet.size > 0 ? Array.from(storeSet) : []).join(', ') || 'No stores';
                const skus = (skuSet.size > 0 ? Array.from(skuSet) : []).join(', ') || 'No SKUs';
                
                const statusColor = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'in_progress': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800',
                    'cancelled': 'bg-red-100 text-red-800'
                }[job.status] || 'bg-gray-100 text-gray-800';

                const shortId = (job.id || '').split('-')[0] || (job.id || '').slice(0,8);
                const isPending = job.status === 'pending';
                const checkboxHtml = isPending ? `
                    <input type="checkbox" 
                           class="job-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                           data-job-id="${job.id}"
                           onchange="updateDeleteButtonState()">
                ` : '<div class="w-4"></div>'; // Spacer for non-pending jobs
                
                return `
                    <div class="px-6 py-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                ${checkboxHtml}
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h4 class="text-lg font-medium text-gray-900">${job.title}</h4>
                                        <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                            ${job.status}
                                        </span>
                                    </div>
                                    <div class="mt-1 text-sm text-gray-500">
                                        <div class="flex items-center gap-2"><strong>ID:</strong> <span id="job-id-${job.id}" title="${job.id}">${shortId}</span> <button class="text-blue-600 hover:text-blue-800 text-xs" onclick="navigator.clipboard.writeText('${job.id}')">Copy</button></div>
                                        <div><strong>Brand:</strong> ${brandName}</div>
                                        <div><strong>Assigned to:</strong> ${assignedUser}</div>
                                        <div><strong>Stores:</strong> ${stores}</div>
                                        <div><strong>Products:</strong> ${skus}</div>
                                        <div><strong>Created:</strong> ${new Date(job.created_at).toLocaleDateString()}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-semibold text-gray-900">$${job.total_payout || 0}</div>
                                <div class="mt-2">
                                    <button onclick="viewJobDetails('${job.id}')" class="text-blue-600 hover:text-blue-800 text-sm">View Details</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            
            // Setup event listeners for bulk delete
            setupBulkDeleteListeners();
        }
        
        // Setup bulk delete functionality
        function setupBulkDeleteListeners() {
            // Select all pending jobs
            const selectAllBtn = document.getElementById('select-all-pending');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const checkboxes = document.querySelectorAll('.job-checkbox');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    
                    checkboxes.forEach(cb => {
                        cb.checked = !allChecked;
                    });
                    
                    window.updateDeleteButtonState();
                });
            }
            
            // Individual checkbox changes
            document.querySelectorAll('.job-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', window.updateDeleteButtonState);
            });
            
            // Delete selected jobs
            const deleteBtn = document.getElementById('delete-selected-jobs');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleBulkDelete);
            }
            
            // Initialize button state
            window.updateDeleteButtonState();
        }
        
        // Update delete button state based on selected checkboxes (globally accessible for inline handlers)
        window.updateDeleteButtonState = function() {
            const checkboxes = document.querySelectorAll('.job-checkbox:checked');
            const deleteBtn = document.getElementById('delete-selected-jobs');
            const countSpan = document.getElementById('selected-count');
            
            const count = checkboxes.length;
            
            if (countSpan) {
                countSpan.textContent = count;
            }
            
            if (deleteBtn) {
                deleteBtn.disabled = count === 0;
            }
        }
        
        // Handle bulk delete with confirmation
        async function handleBulkDelete() {
            const checkboxes = document.querySelectorAll('.job-checkbox:checked');
            const jobIds = Array.from(checkboxes).map(cb => cb.dataset.jobId);
            
            if (jobIds.length === 0) {
                alert('No jobs selected for deletion.');
                return;
            }
            
            // Confirmation dialog
            const confirmMessage = `Are you sure you want to delete ${jobIds.length} pending job(s)?\n\nThis action cannot be undone.`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for large deletions
            if (jobIds.length >= 10) {
                const doubleConfirm = confirm(`‚ö†Ô∏è WARNING: You are about to delete ${jobIds.length} jobs.\n\nThis is a large deletion. Are you absolutely sure?`);
                if (!doubleConfirm) {
                    return;
                }
            }
            
            try {
                console.log(`üóëÔ∏è Deleting ${jobIds.length} jobs...`);
                
                // Delete jobs from Supabase
                const { error } = await supabase
                    .from('jobs')
                    .delete()
                    .in('id', jobIds);
                
                if (error) {
                    console.error('‚ùå Error deleting jobs:', error);
                    alert(`Error deleting jobs: ${error.message}`);
                    return;
                }
                
                console.log(`‚úÖ Successfully deleted ${jobIds.length} jobs`);
                
                // Clear all checkboxes
                document.querySelectorAll('.job-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                
                // Update delete button state (disable it)
                updateDeleteButtonState();
                
                // Reload jobs list with fresh data
                await loadJobsList();
                
                // Force a small delay to ensure DOM is updated, then show success
                await new Promise(resolve => setTimeout(resolve, 200));
                alert(`Successfully deleted ${jobIds.length} job(s).`);
                
            } catch (error) {
                console.error('‚ùå Error in bulk delete:', error);
                alert(`Error deleting jobs: ${error.message}`);
            }
        }

        // View job details (admin edit mode) without full reload
        window.viewJobDetails = async function(jobId) {
            try {
                await loadJobForEdit(jobId);
                if (history && history.pushState) {
                    history.pushState(null, '', `manage-jobs.html?edit_job_id=${jobId}`);
                }
            } catch (e) {
                // Fallback to navigation if inline load fails
                window.location.href = `manage-jobs.html?edit_job_id=${jobId}`;
            }
        }

        // Update job
        async function updateJob(jobId) {
            try {
                console.log('üîÑ Updating job:', jobId);
                
                // Get form data
                const formData = getFormData();
                
                // Ensure brand exists and get brand_id
                const brandId = await ensureBrandExists(formData.brand);
                console.log('‚úÖ Brand ID for update:', brandId);
                
                // Convert dueDate to proper format (datetime-local to ISO string)
                let dueDateValue = null;
                if (formData.dueDate) {
                    // datetime-local returns format: "YYYY-MM-DDTHH:mm"
                    // Convert to ISO string for timestamp with time zone
                    dueDateValue = new Date(formData.dueDate).toISOString();
                }
                
                // Update job
                const { error: jobError } = await supabase
                    .from('jobs')
                    .update({
                        title: formData.title,
                        description: formData.description || null,
                        brand_id: brandId,
                        assigned_user_id: formData.assignedUserId,
                        priority: formData.priority || 'normal',
                        due_date: dueDateValue,
                        instructions: formData.specialInstructions || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', jobId);

                if (jobError) throw jobError;

                // Update stores and SKUs using job_store_skus table (same as create)
                // Get store IDs from formData.stores array (store objects with .id)
                const storeIds = formData.stores.map(store => store.id);
                console.log('‚úÖ Store IDs for update:', storeIds);
                
                // Ensure SKUs exist and get SKU IDs
                const skuIds = await ensureSkusExist(formData.skus, brandId);
                console.log('‚úÖ SKU IDs for update:', skuIds);
                
                // Delete all existing job_store_skus relationships for this job
                const { error: deleteErr } = await supabase
                    .from('job_store_skus')
                    .delete()
                    .eq('job_id', jobId);
                
                if (deleteErr) throw deleteErr;
                
                // Create new job_store_skus relationships (one per store-SKU combination)
                const assignments = [];
                for (const storeId of storeIds) {
                    for (const skuId of skuIds) {
                        assignments.push({
                            job_id: jobId,
                            store_id: storeId,
                            sku_id: skuId
                        });
                    }
                }
                
                if (assignments.length > 0) {
                    const { error: assignmentError } = await supabase
                        .from('job_store_skus')
                        .insert(assignments);
                    
                    if (assignmentError) throw assignmentError;
                    console.log(`‚úÖ Created ${assignments.length} store-SKU assignments`);
                }

                console.log('‚úÖ Job updated successfully');
                alert('Job updated successfully!');
                
                // Return to job list and reload
                window.location.href = 'manage-jobs.html';

            } catch (error) {
                console.error('‚ùå Error updating job:', error);
                alert(`Failed to update job: ${error.message}`);
            }
        }

        // Delete job
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('üîÑ Deleting job:', jobId);
                
                const { error } = await supabase
                    .from('jobs')
                    .delete()
                    .eq('id', jobId);

                if (error) throw error;

                console.log('‚úÖ Job deleted successfully');
                alert('Job deleted successfully!');
                
                // Return to job list and reload
                window.location.href = 'manage-jobs.html';

            } catch (error) {
                console.error('‚ùå Error deleting job:', error);
                alert(`Failed to delete job: ${error.message}`);
            }
        }

        // Add delete button
        function addDeleteButton(jobId) {
            // Remove existing delete button if it exists
            const existingBtn = document.getElementById('delete-job-btn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            // Find the form actions container (where Cancel and Confirm buttons are)
            const formActions = document.querySelector('#job-creation-form .flex.justify-between.pt-6');
            
            if (!formActions) {
                console.warn('Could not find form actions container');
                return;
            }
            
            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.id = 'delete-job-btn';
            deleteBtn.type = 'button';
            deleteBtn.className = 'px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700';
            deleteBtn.textContent = 'Delete Job';
            deleteBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                deleteJob(jobId);
            };
            
            // Insert before the Cancel button (so it's: Delete | Cancel | Confirm)
            const cancelBtn = formActions.querySelector('button[onclick*="goToPage"]');
            if (cancelBtn) {
                formActions.insertBefore(deleteBtn, cancelBtn);
            } else {
                formActions.appendChild(deleteBtn);
            }
        }

        // Update job stores
        async function updateJobStores(jobId, storeIds) {
            // Delete existing job_stores
            await supabase.from('job_stores').delete().eq('job_id', jobId);
            
            // Insert new job_stores
            if (storeIds && storeIds.length > 0) {
                const storeRelations = storeIds.map(storeId => ({
                    job_id: jobId,
                    store_id: storeId
                }));
                
                const { error } = await supabase
                    .from('job_stores')
                    .insert(storeRelations);
                
                if (error) throw error;
            }
        }

        // Update job SKUs
        async function updateJobSkus(jobId, skuIds) {
            // Delete existing job_skus
            await supabase.from('job_skus').delete().eq('job_id', jobId);
            
            // Insert new job_skus
            if (skuIds && skuIds.length > 0) {
                const skuRelations = skuIds.map(skuId => ({
                    job_id: jobId,
                    sku_id: skuId
                }));
                
                const { error } = await supabase
                    .from('job_skus')
                    .insert(skuRelations);
                
                if (error) throw error;
            }
        }

        // Update selected stores display
        function updateSelectedStoresDisplay() {
            const container = document.getElementById('selected-stores');
            if (!container) return;
            
            if (selectedStores.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No stores selected</div>';
                return;
            }
            
            const html = selectedStores.map(store => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span class="text-sm">${store.name} - ${store.city}, ${store.state}</span>
                    <button onclick="removeStoreFromSelection('${store.id}')" class="text-red-500 hover:text-red-700">√ó</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Update selected SKUs display
        function updateSelectedSkusDisplay() {
            const container = document.getElementById('selected-skus');
            if (!container) return;
            
            if (selectedSkus.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No products selected</div>';
                return;
            }
            
            const html = selectedSkus.map(sku => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span class="text-sm">${sku.name} ${sku.upc ? `(${sku.upc})` : ''}</span>
                    <button onclick="removeSkuFromSelection('${sku.id}')" class="text-red-500 hover:text-red-700">√ó</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Set loading state
        function setLoadingState(loading) {
            const button = document.getElementById('confirm-job-btn');
            const submitText = document.getElementById('submit-text');
            const spinner = document.getElementById('loading-spinner');
            
            if (loading) {
                button.disabled = true;
                submitText.textContent = 'Creating Jobs...';
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                submitText.textContent = 'Confirm Job';
                spinner.classList.add('hidden');
            }
        }

        // Sign out function
        async function signOut() {
            try {
                await supabase.auth.signOut();
                window.location.href = '../auth/signin.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Navigation helper
        function goToPage(page) {
            window.location.href = page;
        }
    </script>
</body>
</html>
