<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Jobs - Admin Dashboard</title>
    <script>
        // CRITICAL: Disable global guard BEFORE any other scripts load
        window.SA_DISABLE_GLOBAL_GUARD = true;
        window.SA_PAGE_ROLE = 'admin';
        console.log('üîí Global guard disabled for Manage Jobs page');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.5/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="../shared/styles.css">
</head>
<body>
    <div class="min-h-screen bg-gray-100">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">Manage Jobs</h1>
                        <span class="ml-3 px-2 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">ADMIN ONLY</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="create-job-btn" onclick="showCreateJobForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Create New Job</button>
                        <a href="dashboard.html" class="text-gray-600 hover:text-gray-900">‚Üê Back to Dashboard</a>
                        <button onclick="signOut()" class="text-gray-600 hover:text-gray-900">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Jobs List Section (Default View) -->
            <div id="jobs-list-section">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">All Jobs</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Total Jobs</div>
                            <div id="total-jobs-count" class="text-2xl font-bold text-gray-900">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Pending</div>
                            <div id="pending-jobs-count" class="text-2xl font-bold text-yellow-600">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Completed</div>
                            <div id="completed-jobs-count" class="text-2xl font-bold text-green-600">0</div>
                        </div>
                    </div>
                </div>
                
                <div id="jobs-table-container" class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Job List</h3>
                    </div>
                    <div id="jobs-table-body" class="divide-y divide-gray-200">
                        <!-- Jobs will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Create Job Form Section (Hidden by Default) -->
            <div id="create-job-section" class="hidden">
            <!-- Job Creation Form -->
            <div class="bg-white rounded-lg shadow-sm border p-8">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Create New Job</h2>
                    <p class="text-gray-600">Create shelf audit jobs for shelfers to complete</p>
                </div>

                <!-- Error Messages -->
                <div id="error-messages" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error creating job</h3>
                            <div id="error-details" class="mt-2 text-sm text-red-700"></div>
                            <div class="mt-4 flex space-x-3">
                                <button id="retry-button" class="text-sm bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200">Try Again</button>
                                <button id="cancel-button" class="text-sm bg-gray-100 text-gray-800 px-3 py-1 rounded hover:bg-gray-200">Cancel and Exit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success Messages -->
                <div id="success-messages" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Jobs created successfully!</h3>
                            <div id="success-details" class="mt-2 text-sm text-green-700"></div>
                        </div>
                    </div>
                </div>

                <form id="job-creation-form" class="space-y-6">
                    <!-- Job Title -->
                    <div>
                        <label for="job-title" class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                        <input type="text" id="job-title" name="job-title" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., DJ's Boudain Shelf Audit">
                        <p class="mt-1 text-sm text-gray-500">5-255 characters</p>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="job-description" class="block text-sm font-medium text-gray-700 mb-2">Job Description</label>
                        <textarea id="job-description" name="job-description" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Optional description of the job requirements"></textarea>
                        <p class="mt-1 text-sm text-gray-500">Maximum 2000 characters</p>
                    </div>

                    <!-- Brand Selection -->
                    <div>
                        <label for="brand-name" class="block text-sm font-medium text-gray-700 mb-2">Brand *</label>
                        <div class="relative">
                            <input type="text" id="brand-name" name="brand-name" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="e.g., DJ's Boudain, Callie's Hot Little Biscuits">
                            <div id="brand-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg hidden"></div>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Type brand name - will create new brand if not found</p>
                    </div>

                    <!-- Enhanced Store Selection -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">Store Selection *</label>
                            <div class="flex space-x-2">
                                <button type="button" onclick="console.log('Select All Filtered clicked'); if(window.storeSelector) { window.storeSelector.selectAllFiltered(); } else { console.error('storeSelector not found'); }" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Select All Filtered
                                </button>
                                <button type="button" onclick="console.log('Clear All clicked'); if(window.storeSelector) { window.storeSelector.clearAll(); } else { console.error('storeSelector not found'); }" 
                                        class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                    Clear All
                                </button>
                            </div>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Search Input -->
                            <div>
                                <label for="store-search" class="block text-sm font-medium text-gray-700 mb-1">Search Stores</label>
                                <input type="text" id="store-search" placeholder="Search by name, city, address, or ZIP..."
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <!-- Chain Filter -->
                            <div>
                                <label for="chain-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Chain</label>
                                <select id="chain-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="all">All Chains</option>
                                    <!-- Banner options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <!-- Location Services -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-blue-900">üìç Location Services</div>
                                    <div class="text-sm text-blue-700">Get nearby store suggestions based on your location</div>
                                </div>
                                <button type="button" onclick="storeSelector.getCurrentLocation()" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Enable Location
                                </button>
                            </div>
                        </div>

                        <!-- Selected Stores Display -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2">
                                Selected Stores (<span id="selected-count">0</span>)
                            </div>
                            <div id="selected-stores" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-center text-gray-500 py-4">No stores selected</div>
                            </div>
                        </div>

                        <!-- Store Search Results -->
                        <div>
                            <div class="text-sm font-medium text-gray-700 mb-2">
                                Available Stores (<span id="filtered-count">0</span>)
                            </div>
                            <div id="store-search-results" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-center text-gray-500 py-4">Loading stores...</div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-700 mb-2">Quick Actions</div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <button type="button" onclick="storeSelector.filterByChain('heb')" 
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                    H-E-B Only
                                </button>
                                <button type="button" onclick="storeSelector.filterByChain('whole foods market')" 
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                    Whole Foods Market
                                </button>
                                <button type="button" onclick="storeSelector.filterByChain('tom thumb')" 
                                        class="px-3 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                                    Tom Thumb
                                </button>
                                <button type="button" onclick="storeSelector.filterByChain('all')" 
                                        class="px-3 py-2 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                    All Chains
                                </button>
                            </div>
                        </div>

                        <!-- Help Text -->
                        <div class="text-sm text-gray-500">
                            <p>üí° <strong>Tips:</strong></p>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>Search by store name, city, address, or ZIP code</li>
                                <li>Use location services to find stores near you</li>
                                <li>Filter by chain to focus on specific retailers</li>
                                <li>Click on stores to select them for the job</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Product Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Products to Check *</label>
                        <div id="sku-selection" class="space-y-2">
                            <div class="space-y-2">
                                <input type="text" id="product-name" placeholder="Product name (e.g., Original Boudain)" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <input type="text" id="product-sku" placeholder="SKU/UPC (optional, e.g., 0123456789012)" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button type="button" onclick="addSkuInput()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Product</button>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Add products to audit - SKU/UPC can be added later in store if not known</p>
                    </div>

                    <!-- Assigned User -->
                    <div>
                        <label for="assigned-user" class="block text-sm font-medium text-gray-700 mb-2">Assigned To *</label>
                        <select id="assigned-user" name="assigned-user" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select user...</option>
                        </select>
                    </div>

                    <!-- Priority -->
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select id="priority" name="priority"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="normal">Normal</option>
                            <option value="low">Low</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>

                    <!-- Due Date -->
                    <div>
                        <label for="due-date" class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="datetime-local" id="due-date" name="due-date"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="mt-1 text-sm text-gray-500">Standard timeline: 48 hours (placeholder for Marc's feedback)</p>
                    </div>

                    <!-- Additional Notes -->
                    <div>
                        <label for="special-instructions" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                        <textarea id="special-instructions" name="special-instructions" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder=""></textarea>
                        <p class="mt-1 text-sm text-gray-500">Standard requirements: 3 photos (product on shelf, price tag, overall shelf view) + price verification + stock level check. Beyond this requires custom audit.</p>
                    </div>

                    <!-- Job Summary -->
                    <div id="job-summary" class="hidden bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Job Summary</h3>
                        <div id="summary-details" class="text-sm text-gray-600"></div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-between pt-6 border-t border-gray-200">
                        <button type="button" onclick="goToPage('dashboard.html')" 
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" id="confirm-job-btn"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="submit-text">Confirm Job</span>
                            <span id="loading-spinner" class="hidden ml-2">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../shared/api.js?v=20250113-4"></script>
    <script src="enhanced-store-selector.js?v=20250113-10"></script>
    <script>
        // Global variables
        let brands = [];
        let stores = [];
        let skus = [];
        let users = [];
        let selectedStores = [];
        let selectedSkus = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üîÑ Starting job management form initialization...');
                
                // Check if supabase is available
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase not available');
                }
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('‚ùå No user found, redirecting to signin');
                    window.location.href = '../auth/signin.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', user.email);
                
                // Check if we're in edit mode
                const urlParams = new URLSearchParams(window.location.search);
                const editJobId = urlParams.get('edit_job_id');
                
                if (editJobId) {
                    console.log('üîÑ Edit mode detected for job:', editJobId);
                    await loadJobForEdit(editJobId);
                } else {
                    console.log('üîÑ Create mode - loading initial data...');
                    await loadInitialData();
                }
                
                // Setup form event listeners
                console.log('üîÑ Setting up form event listeners...');
                setupFormEventListeners();
                
                // Setup error handling
                console.log('üîÑ Setting up error handling...');
                setupErrorHandling();
                
                // Load jobs list by default (unless in edit mode)
                if (!editJobId) {
                    await loadJobsList();
                }
                
                console.log('‚úÖ Job management form initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing job creation form:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                showError('Failed to load job creation form. Please refresh the page.');
            }
        });

        // Load job for edit mode
        async function loadJobForEdit(jobId) {
            try {
                console.log('üîÑ Loading job for edit:', jobId);
                
                // Load job with all related data
                const { data: job, error } = await supabase
                    .from('jobs')
                    .select(`
                        *,
                        brands(name),
                        job_stores(stores(id, name, city, state)),
                        job_skus(skus(id, name, upc)),
                        users(full_name)
                    `)
                    .eq('id', jobId)
                    .single();

                if (error) {
                    console.error('‚ùå Error loading job:', error);
                    throw new Error(`Job not found or error loading: ${error.message}`);
                }
                
                if (!job) {
                    throw new Error('Job not found');
                }
                
                console.log('‚úÖ Job loaded for edit:', job);
                
                // Populate form fields
                document.getElementById('job-title').value = job.title || '';
                document.getElementById('job-description').value = job.description || '';
                document.getElementById('brand-input').value = job.brands?.name || '';
                
                // Set priority
                if (job.priority) {
                    document.getElementById('priority').value = job.priority;
                }
                
                // Set due date
                if (job.due_date) {
                    const dueDate = new Date(job.due_date).toISOString().split('T')[0];
                    document.getElementById('due-date').value = dueDate;
                }
                
                // Set assigned user
                if (job.assigned_to) {
                    document.getElementById('assigned-user').value = job.assigned_to;
                }
                
                // Set additional notes
                if (job.additional_notes) {
                    document.getElementById('additional-notes').value = job.additional_notes;
                }
                
                // Populate stores
                if (job.job_stores && job.job_stores.length > 0) {
                    selectedStores = job.job_stores.map(js => js.stores);
                    updateSelectedStoresDisplay();
                }
                
                // Populate SKUs
                if (job.job_skus && job.job_skus.length > 0) {
                    selectedSkus = job.job_skus.map(js => js.skus);
                    updateSelectedSkusDisplay();
                }
                
                // Change form title and button
                document.querySelector('h2').textContent = 'Edit Job';
                const confirmBtn = document.getElementById('confirm-job-btn');
                if (confirmBtn) {
                    confirmBtn.textContent = 'Save Changes';
                    confirmBtn.onclick = () => updateJob(jobId);
                }
                
                // Add delete button
                addDeleteButton(jobId);
                
                // Show form and hide job list
                document.getElementById('job-creation-form').style.display = 'block';
                document.getElementById('jobs-list-section').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error loading job for edit:', error);
                
                // If job doesn't exist, redirect to clean page
                if (error.message.includes('not found') || error.message.includes('Job not found')) {
                    console.log('üîÑ Job not found, redirecting to clean page...');
                    window.location.href = 'manage-jobs.html';
                    return;
                }
                
                showError('Failed to load job for editing. Please try again.');
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                console.log('üîÑ Loading initial data...');
                
                // Load brands, skus, and users (stores are loaded by enhanced store selector)
                const [brandsResult, skusResult, usersResult] = await Promise.all([
                    supabase.from('brands').select('*').order('name'),
                    supabase.from('skus').select('*').order('name'),
                    supabase.from('users').select('*').eq('is_active', true).order('full_name')
                ]);

                brands = brandsResult.data || [];
                skus = skusResult.data || [];
                users = usersResult.data || [];
                
                // Initialize stores as empty array (will be populated by enhanced store selector)
                stores = [];

                // Populate assigned user dropdown
                populateUserDropdown();
                
                console.log('üìä Loaded data:', {
                    brands: brands.length,
                    stores: 'loaded by enhanced store selector',
                    skus: skus.length,
                    users: users.length
                });
                
            } catch (error) {
                console.error('‚ùå Error loading initial data:', error);
                // Don't throw error, just log it and continue
                brands = [];
                skus = [];
                users = [];
                stores = [];
            }
        }

        // Populate user dropdown (filtered to Courtney and Marc only)
        function populateUserDropdown() {
            const select = document.getElementById('assigned-user');
            select.innerHTML = '<option value="">Select user...</option>';
            
            // Filter to only show Courtney and Marc
            const filteredUsers = users.filter(user => {
                const name = (user.full_name || '').toLowerCase();
                return name.includes('courtney') || name.includes('marc');
            });
            
            filteredUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.full_name || 'No name'} (${user.role})`;
                select.appendChild(option);
            });
        }

        // Setup form event listeners
        function setupFormEventListeners() {
            try {
                console.log('üîÑ Setting up brand autocomplete...');
                // Brand autocomplete
                const brandInput = document.getElementById('brand-name');
                console.log('Brand input element:', brandInput);
                if (brandInput) {
                    brandInput.addEventListener('input', handleBrandInput);
                    brandInput.addEventListener('blur', hideBrandSuggestions);
                    console.log('‚úÖ Brand autocomplete setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Brand input element not found');
                }
                
                console.log('üîÑ Setting up form submission...');
                // Form submission
                const form = document.getElementById('job-creation-form');
                console.log('Form element:', form);
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                    console.log('‚úÖ Form submission setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Form element not found');
                }
                
                console.log('üîÑ Setting up real-time validation...');
                // Real-time validation
                const jobTitle = document.getElementById('job-title');
                console.log('Job title element:', jobTitle);
                if (jobTitle) {
                    jobTitle.addEventListener('input', updateJobSummary);
                    console.log('‚úÖ Real-time validation setup complete');
                } else {
                    console.warn('‚ö†Ô∏è Job title element not found');
                }
                
                console.log('‚úÖ Form event listeners setup complete');
            } catch (error) {
                console.error('‚ùå Error setting up form event listeners:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                throw error;
            }
        }

        // Setup error handling
        function setupErrorHandling() {
            try {
                console.log('üîÑ Setting up error handling...');
                const retryButton = document.getElementById('retry-button');
                if (retryButton) {
                    retryButton.addEventListener('click', () => {
                        hideError();
                        // Form data is preserved, user can try again
                    });
                }
                
                const cancelButton = document.getElementById('cancel-button');
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        window.location.href = 'dashboard.html';
                    });
                }
                
                console.log('‚úÖ Error handling setup complete');
            } catch (error) {
                console.error('‚ùå Error setting up error handling:', error);
                // Don't throw error for error handling setup
            }
        }

        // Brand input handling
        function handleBrandInput(event) {
            const query = event.target.value.toLowerCase().trim();
            if (query.length < 2) {
                hideBrandSuggestions();
                return;
            }
            
            const matches = brands.filter(brand => 
                brand.name.toLowerCase().includes(query)
            );
            
            showBrandSuggestions(matches);
        }

        // Show brand suggestions
        function showBrandSuggestions(matches) {
            const container = document.getElementById('brand-suggestions');
            container.innerHTML = '';
            
            if (matches.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500">No matching brands found</div>';
            } else {
                matches.forEach(brand => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-200 last:border-b-0';
                    div.textContent = brand.name;
                    div.addEventListener('click', () => {
                        document.getElementById('brand-name').value = brand.name;
                        hideBrandSuggestions();
                        updateJobSummary();
                    });
                    container.appendChild(div);
                });
            }
            
            container.classList.remove('hidden');
        }

        // Hide brand suggestions
        function hideBrandSuggestions() {
            document.getElementById('brand-suggestions').classList.add('hidden');
        }

        // Handle all stores checkbox
        function handleAllStoresChange(event) {
            const storeSelection = document.getElementById('store-selection');
            if (event.target.checked) {
                storeSelection.style.display = 'none';
                selectedStores = stores.map(store => store.name);
            } else {
                storeSelection.style.display = 'block';
                // Don't clear manually added stores when unchecking "All active stores"
                // selectedStores = []; // REMOVED - this was clearing user's manual entries
            }
            updateJobSummary();
        }

        // Add store input
        function addStoreInput() {
            const container = document.getElementById('store-selection');
            const input = container.querySelector('input');
            const storeName = input.value.trim();
            
            if (!storeName) {
                alert('Please enter a store name');
                return;
            }
            
            if (selectedStores.includes(storeName)) {
                alert('Store already added');
                return;
            }
            
            selectedStores.push(storeName);
            input.value = '';
            updateJobSummary();
            updateStoreDisplay();
        }

        // Add SKU input
        function addSkuInput() {
            const productName = document.getElementById('product-name').value.trim();
            const productSku = document.getElementById('product-sku').value.trim();
            
            if (!productName) {
                alert('Please enter a product name');
                return;
            }
            
            // Check if product name already exists
            const existingProduct = selectedSkus.find(sku => sku.name === productName);
            if (existingProduct) {
                alert('Product already added');
                return;
            }
            
            // Add product with both name and SKU (SKU can be empty)
            const productData = {
                name: productName,
                sku: productSku || null
            };
            
            selectedSkus.push(productData);
            
            // Clear inputs
            document.getElementById('product-name').value = '';
            document.getElementById('product-sku').value = '';
            
            updateJobSummary();
            updateSkuDisplay();
        }

        // Update store display
        function updateStoreDisplay() {
            const container = document.getElementById('store-selection');
            const existingDisplay = container.querySelector('.selected-stores');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            if (selectedStores.length > 0) {
                const display = document.createElement('div');
                display.className = 'selected-stores mt-2 p-2 bg-gray-50 rounded';
                display.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mb-1">Selected Stores:</div>
                    <div class="flex flex-wrap gap-2">
                        ${selectedStores.map(store => `
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                ${store}
                                <button type="button" onclick="removeStore('${store}')" class="ml-1 text-blue-600 hover:text-blue-800">√ó</button>
                            </span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(display);
            }
        }

        // Update SKU display
        function updateSkuDisplay() {
            const container = document.getElementById('sku-selection');
            const existingDisplay = container.querySelector('.selected-skus');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            if (selectedSkus.length > 0) {
                const display = document.createElement('div');
                display.className = 'selected-skus mt-2 p-2 bg-gray-50 rounded';
                display.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mb-1">Selected Products:</div>
                    <div class="flex flex-wrap gap-2">
                        ${selectedSkus.map((sku, index) => `
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                ${sku.name}${sku.sku ? ` (${sku.sku})` : ''}
                                <button type="button" onclick="removeSku(${index})" class="ml-1 text-green-600 hover:text-green-800">√ó</button>
                            </span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(display);
            }
        }

        // Remove store
        function removeStore(storeName) {
            selectedStores = selectedStores.filter(s => s !== storeName);
            updateJobSummary();
            updateStoreDisplay();
        }

        // Remove SKU
        function removeSku(index) {
            selectedSkus.splice(index, 1);
            updateJobSummary();
            updateSkuDisplay();
        }

        // Update job summary
        function updateJobSummary() {
            const title = document.getElementById('job-title').value.trim();
            const brand = document.getElementById('brand-name').value.trim();
            
            // Get selected stores from enhanced store selector
            const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
            const skus = selectedSkus;
            
            if (title && brand && selectedStores.length > 0 && skus.length > 0) {
                const totalJobs = selectedStores.length * skus.length;
                const summary = document.getElementById('summary-details');
                summary.innerHTML = `
                    <div class="space-y-1">
                        <div><strong>Title:</strong> ${title}</div>
                        <div><strong>Brand:</strong> ${brand}</div>
                        <div><strong>Stores:</strong> ${selectedStores.length}</div>
                        <div><strong>Products:</strong> ${skus.length}</div>
                        <div class="font-medium text-blue-600"><strong>Total Jobs:</strong> ${totalJobs}</div>
                    </div>
                `;
                document.getElementById('job-summary').classList.remove('hidden');
            } else {
                document.getElementById('job-summary').classList.add('hidden');
            }
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            try {
                // Validate form
                if (!validateForm()) {
                    return;
                }
                
                // Show loading state
                setLoadingState(true);
                hideError();
                hideSuccess();
                
                // Get form data
                const formData = getFormData();
                
                // Create jobs
                const result = await createJobs(formData);
                
                // Show success
                showSuccess(result);
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error creating jobs:', error);
                showError(error.message);
            } finally {
                setLoadingState(false);
            }
        }

        // Validate form
        function validateForm() {
            const title = document.getElementById('job-title').value.trim();
            const brand = document.getElementById('brand-name').value.trim();
            const assignedUser = document.getElementById('assigned-user').value;
            
            // Get selected stores from enhanced store selector
            const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
            
            if (!title || title.length < 5) {
                alert('Job title must be at least 5 characters');
                return false;
            }
            
            if (!brand) {
                alert('Brand name is required');
                return false;
            }
            
            if (selectedStores.length === 0) {
                alert('Please select at least one store');
                return false;
            }
            
            if (selectedSkus.length === 0) {
                alert('Please add at least one product (SKU)');
                return false;
            }
            
            if (!assignedUser) {
                alert('Please select an assigned user');
                return false;
            }
            
            return true;
        }

        // Get form data
        function getFormData() {
            // Get selected stores from enhanced store selector
            const selectedStores = storeSelector ? storeSelector.getSelectedStores() : [];
            
            return {
                title: document.getElementById('job-title').value.trim(),
                description: document.getElementById('job-description').value.trim(),
                brand: document.getElementById('brand-name').value.trim(),
                stores: selectedStores, // Use enhanced store selector
                skus: selectedSkus,
                assignedUserId: document.getElementById('assigned-user').value,
                priority: document.getElementById('priority').value,
                dueDate: document.getElementById('due-date').value,
                specialInstructions: document.getElementById('special-instructions').value.trim()
            };
        }

        // Create jobs
        async function createJobs(formData) {
            const errors = [];
            const createdJobs = [];
            
            try {
                console.log('üîÑ Creating jobs with form data:', formData);
                
                // Ensure brand exists
                let brandId = await ensureBrandExists(formData.brand);
                console.log('‚úÖ Brand ID:', brandId);
                
                // Get store IDs from enhanced store selector (no need to create new stores)
                const storeIds = formData.stores.map(store => store.id);
                console.log('‚úÖ Store IDs:', storeIds);
                
                // Ensure SKUs exist
                const skuIds = await ensureSkusExist(formData.skus, brandId);
                console.log('‚úÖ SKU IDs:', skuIds);
                
                // Create jobs (one per store-SKU combination)
                for (const storeId of storeIds) {
                    for (const skuId of skuIds) {
                        try {
                            const jobData = {
                                title: formData.title,
                                description: formData.description,
                                brand_id: brandId,
                                assigned_user_id: formData.assignedUserId,
                                priority: formData.priority,
                                due_date: formData.dueDate || null,
                                instructions: formData.specialInstructions,
                                status: 'pending',
                                payout_per_store: 5.00, // Standard $5 per store
                                created_at: new Date().toISOString()
                            };
                            
                            const { data: job, error } = await supabase
                                .from('jobs')
                                .insert(jobData)
                                .select()
                                .single();
                            
                            if (error) throw error;
                            
                            console.log('‚úÖ Job created:', job.id);
                            
                            // Link job to store and SKU
                            const { error: storeError } = await supabase.from('job_stores').insert({
                                job_id: job.id,
                                store_id: storeId
                            });
                            
                            if (storeError) {
                                console.error('‚ùå Error linking store:', storeError);
                                throw storeError;
                            }
                            console.log('‚úÖ Store linked:', storeId);
                            
                            const { error: skuError } = await supabase.from('job_skus').insert({
                                job_id: job.id,
                                sku_id: skuId
                            });
                            
                            if (skuError) {
                                console.error('‚ùå Error linking SKU:', skuError);
                                throw skuError;
                            }
                            console.log('‚úÖ SKU linked:', skuId);
                            
                            createdJobs.push(job);
                            
                        } catch (error) {
                            console.error(`‚ùå Error creating job for store ${storeId}, SKU ${skuId}:`, error);
                            errors.push(`Failed to create job for store-SKU combination: ${error.message}`);
                        }
                    }
                }
                
                if (errors.length > 0 && createdJobs.length === 0) {
                    throw new Error(`All jobs failed to create: ${errors.join(', ')}`);
                }
                
                return {
                    created: createdJobs.length,
                    errors: errors.length,
                    total: storeIds.length * skuIds.length
                };
                
            } catch (error) {
                console.error('‚ùå Error in createJobs:', error);
                throw error;
            }
        }

        // Ensure brand exists
        async function ensureBrandExists(brandName) {
            const existingBrand = brands.find(b => b.name.toLowerCase() === brandName.toLowerCase());
            if (existingBrand) {
                return existingBrand.id;
            }
            
            const { data: brand, error } = await supabase
                .from('brands')
                .insert({ name: brandName })
                .select()
                .single();
            
            if (error) throw new Error(`Failed to create brand: ${error.message}`);
            
            brands.push(brand);
            return brand.id;
        }

        // Ensure stores exist
        async function ensureStoresExist(storeNames) {
            const storeIds = [];
            
            for (const storeName of storeNames) {
                const existingStore = stores.find(s => s.name.toLowerCase() === storeName.toLowerCase());
                if (existingStore) {
                    storeIds.push(existingStore.id);
                } else {
                    const { data: store, error } = await supabase
                        .from('stores')
                        .insert({ name: storeName })
                        .select()
                        .single();
                    
                    if (error) throw new Error(`Failed to create store: ${error.message}`);
                    
                    stores.push(store);
                    storeIds.push(store.id);
                }
            }
            
            return storeIds;
        }

        // Ensure SKUs exist
        async function ensureSkusExist(skuData, brandId) {
            const skuIds = [];
            
            for (const skuItem of skuData) {
                // Check if SKU exists by name (case insensitive)
                const existingSku = skus.find(s => s.name.toLowerCase() === skuItem.name.toLowerCase());
                if (existingSku) {
                    skuIds.push(existingSku.id);
                } else {
                    // Create new SKU with both name and UPC (UPC can be null)
                    const { data: sku, error } = await supabase
                        .from('skus')
                        .insert({ 
                            name: skuItem.name,
                            upc: skuItem.sku || null, // UPC can be null if not provided
                            brand_id: brandId
                        })
                        .select()
                        .single();
                    
                    if (error) throw new Error(`Failed to create SKU: ${error.message}`);
                    
                    skus.push(sku);
                    skuIds.push(sku.id);
                }
            }
            
            return skuIds;
        }

        // Show error
        function showError(message) {
            document.getElementById('error-details').textContent = message;
            document.getElementById('error-messages').classList.remove('hidden');
        }

        // Hide error
        function hideError() {
            document.getElementById('error-messages').classList.add('hidden');
        }

        // Show success
        function showSuccess(result) {
            const details = document.getElementById('success-details');
            details.innerHTML = `
                <div class="space-y-1">
                    <div>‚úÖ Created ${result.created} jobs successfully</div>
                    ${result.errors > 0 ? `<div>‚ö†Ô∏è ${result.errors} jobs failed</div>` : ''}
                    <div>üìä Total expected: ${result.total} jobs</div>
                </div>
            `;
            document.getElementById('success-messages').classList.remove('hidden');
        }

        // Hide success
        function hideSuccess() {
            document.getElementById('success-messages').classList.add('hidden');
        }

        // Show create job form
        function showCreateJobForm() {
            document.getElementById('jobs-list-section').classList.add('hidden');
            document.getElementById('create-job-section').classList.remove('hidden');
            document.getElementById('create-job-btn').textContent = 'Back to Jobs List';
            document.getElementById('create-job-btn').onclick = showJobsList;
        }

        // Show jobs list
        function showJobsList() {
            document.getElementById('create-job-section').classList.add('hidden');
            document.getElementById('jobs-list-section').classList.remove('hidden');
            document.getElementById('create-job-btn').textContent = 'Create New Job';
            document.getElementById('create-job-btn').onclick = showCreateJobForm;
        }

        // Load jobs list
        async function loadJobsList() {
            try {
                console.log('üîÑ Loading jobs list...');
                
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select(`
                        *,
                        brands(name),
                        users(full_name),
                        job_stores(stores(name, city, state)),
                        job_skus(skus(name))
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                console.log('üìä Jobs loaded:', jobs);

                // Update counts
                const totalJobs = jobs.length;
                const pendingJobs = jobs.filter(job => job.status === 'pending').length;
                const completedJobs = jobs.filter(job => job.status === 'completed').length;

                document.getElementById('total-jobs-count').textContent = totalJobs;
                document.getElementById('pending-jobs-count').textContent = pendingJobs;
                document.getElementById('completed-jobs-count').textContent = completedJobs;

                // Render jobs table
                renderJobsTable(jobs);

            } catch (error) {
                console.error('‚ùå Error loading jobs:', error);
                document.getElementById('jobs-table-body').innerHTML = '<div class="p-6 text-center text-red-500">Error loading jobs. Please refresh.</div>';
            }
        }

        // Render jobs table
        function renderJobsTable(jobs) {
            const container = document.getElementById('jobs-table-body');
            
            if (jobs.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">No jobs found</div>';
                return;
            }

            const html = jobs.map(job => {
                const brandName = job.brands?.name || 'Unknown Brand';
                const assignedUser = job.users?.full_name || 'Unassigned';
                const stores = job.job_stores?.map(js => js.stores?.name || 'Unknown Store').join(', ') || 'No stores';
                const skus = job.job_skus?.map(js => js.skus?.name || 'Unknown SKU').join(', ') || 'No SKUs';
                
                const statusColor = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'in_progress': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800',
                    'cancelled': 'bg-red-100 text-red-800'
                }[job.status] || 'bg-gray-100 text-gray-800';

                return `
                    <div class="px-6 py-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <h4 class="text-lg font-medium text-gray-900">${job.title}</h4>
                                    <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                        ${job.status}
                                    </span>
                                </div>
                                <div class="mt-1 text-sm text-gray-500">
                                    <div><strong>Brand:</strong> ${brandName}</div>
                                    <div><strong>Assigned to:</strong> ${assignedUser}</div>
                                    <div><strong>Stores:</strong> ${stores}</div>
                                    <div><strong>Products:</strong> ${skus}</div>
                                    <div><strong>Created:</strong> ${new Date(job.created_at).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-semibold text-gray-900">$${job.total_payout || 0}</div>
                                <div class="mt-2">
                                    <button onclick="viewJobDetails('${job.id}')" class="text-blue-600 hover:text-blue-800 text-sm">View Details</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // View job details (admin edit mode)
        function viewJobDetails(jobId) {
            console.log('Opening job for edit:', jobId);
            window.location.href = `manage-jobs.html?edit_job_id=${jobId}`;
        }

        // Update job
        async function updateJob(jobId) {
            try {
                console.log('üîÑ Updating job:', jobId);
                
                // Get form data
                const formData = getFormData();
                
                // Update job
                const { error: jobError } = await supabase
                    .from('jobs')
                    .update({
                        title: formData.title,
                        description: formData.description,
                        brand_id: formData.brandId,
                        assigned_to: formData.assignedTo,
                        priority: formData.priority,
                        due_date: formData.dueDate,
                        additional_notes: formData.additionalNotes,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', jobId);

                if (jobError) throw jobError;

                // Update stores
                await updateJobStores(jobId, formData.stores);
                
                // Update SKUs
                await updateJobSkus(jobId, formData.skus);

                console.log('‚úÖ Job updated successfully');
                showSuccess('Job updated successfully!');
                
                // Return to job list
                setTimeout(() => {
                    window.location.href = 'manage-jobs.html';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error updating job:', error);
                showError('Failed to update job. Please try again.');
            }
        }

        // Delete job
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('üîÑ Deleting job:', jobId);
                
                const { error } = await supabase
                    .from('jobs')
                    .delete()
                    .eq('id', jobId);

                if (error) throw error;

                console.log('‚úÖ Job deleted successfully');
                showSuccess('Job deleted successfully!');
                
                // Return to job list
                setTimeout(() => {
                    window.location.href = 'manage-jobs.html';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error deleting job:', error);
                showError('Failed to delete job. Please try again.');
            }
        }

        // Add delete button
        function addDeleteButton(jobId) {
            const form = document.getElementById('job-creation-form');
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn-red mt-4';
            deleteBtn.textContent = 'Delete Job';
            deleteBtn.onclick = () => deleteJob(jobId);
            form.appendChild(deleteBtn);
        }

        // Update job stores
        async function updateJobStores(jobId, storeIds) {
            // Delete existing job_stores
            await supabase.from('job_stores').delete().eq('job_id', jobId);
            
            // Insert new job_stores
            if (storeIds && storeIds.length > 0) {
                const storeRelations = storeIds.map(storeId => ({
                    job_id: jobId,
                    store_id: storeId
                }));
                
                const { error } = await supabase
                    .from('job_stores')
                    .insert(storeRelations);
                
                if (error) throw error;
            }
        }

        // Update job SKUs
        async function updateJobSkus(jobId, skuIds) {
            // Delete existing job_skus
            await supabase.from('job_skus').delete().eq('job_id', jobId);
            
            // Insert new job_skus
            if (skuIds && skuIds.length > 0) {
                const skuRelations = skuIds.map(skuId => ({
                    job_id: jobId,
                    sku_id: skuId
                }));
                
                const { error } = await supabase
                    .from('job_skus')
                    .insert(skuRelations);
                
                if (error) throw error;
            }
        }

        // Update selected stores display
        function updateSelectedStoresDisplay() {
            const container = document.getElementById('selected-stores');
            if (!container) return;
            
            if (selectedStores.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No stores selected</div>';
                return;
            }
            
            const html = selectedStores.map(store => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span class="text-sm">${store.name} - ${store.city}, ${store.state}</span>
                    <button onclick="removeStoreFromSelection('${store.id}')" class="text-red-500 hover:text-red-700">√ó</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Update selected SKUs display
        function updateSelectedSkusDisplay() {
            const container = document.getElementById('selected-skus');
            if (!container) return;
            
            if (selectedSkus.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No products selected</div>';
                return;
            }
            
            const html = selectedSkus.map(sku => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span class="text-sm">${sku.name} ${sku.upc ? `(${sku.upc})` : ''}</span>
                    <button onclick="removeSkuFromSelection('${sku.id}')" class="text-red-500 hover:text-red-700">√ó</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Set loading state
        function setLoadingState(loading) {
            const button = document.getElementById('confirm-job-btn');
            const submitText = document.getElementById('submit-text');
            const spinner = document.getElementById('loading-spinner');
            
            if (loading) {
                button.disabled = true;
                submitText.textContent = 'Creating Jobs...';
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                submitText.textContent = 'Confirm Job';
                spinner.classList.add('hidden');
            }
        }

        // Sign out function
        async function signOut() {
            try {
                await supabase.auth.signOut();
                window.location.href = '../auth/signin.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Navigation helper
        function goToPage(page) {
            window.location.href = page;
        }
    </script>
</body>
</html>
